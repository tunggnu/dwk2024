{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-5/2-custom-resource-definitions-vi","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Mục tiêu học tập"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Sau phần này, bạn có thể"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tạo Định nghĩa Tài nguyên Tùy chỉnh (Custom Resource Definitions) của riêng mình"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Custom Resource Definitions"}]},{"type":"text","value":" (CRDs) là cách để mở rộng Kubernetes với các tài nguyên (Resource) của riêng chúng ta. Chúng ta đã sử dụng rất nhiều CRD rồi, ví dụ ở "},{"type":"element","tagName":"a","properties":{"href":"/part-4/3-gitops"},"children":[{"type":"text","value":"phần 4"}]},{"type":"text","value":" chúng ta đã dùng "},{"type":"element","tagName":"a","properties":{"href":"https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#applications","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Application"}]},{"type":"text","value":" với ArgoCD."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chúng là một phần không thể thiếu khi sử dụng Kubernetes nên rất đáng để học cách tự tạo một CRD."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Trước khi bắt đầu, chúng ta cần xác định mình muốn tạo gì. Hãy tạo một resource có thể dùng để tạo các bộ đếm ngược (countdown). Resource này sẽ tên là \"Countdown\". Nó sẽ có thuộc tính "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"length"}]},{"type":"text","value":" (độ dài) và "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"delay"}]},{"type":"text","value":" (khoảng thời gian giữa các lần thực thi). Việc thực thi - tức là mỗi lần "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"delay"}]},{"type":"text","value":" trôi qua sẽ làm gì - sẽ do một image quyết định. Như vậy, ai đó dùng CRD của chúng ta có thể tạo một countdown mà mỗi lần đếm sẽ, ví dụ, đăng một tin lên Twitter."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Làm mẫu, tôi sẽ dùng template từ "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"tài liệu"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"resourcedefinition.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apiextensions.k8s.io/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" CustomResourceDefinition\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# name phải khớp với các trường spec bên dưới, và có dạng: <plural>.<group>"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdowns.stable.dwk\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# group name dùng cho REST API: /apis/<group>/<version>"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"group"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" stable.dwk\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# hoặc Namespaced hoặc Cluster"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"scope"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Namespaced\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"names"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# kind thường là dạng CamelCase số ít. Resource manifest sẽ dùng trường này."}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Countdown\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# plural dùng trong URL: /apis/<group>/<version>/<plural>"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"plural"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdowns\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# singular dùng làm alias trên CLI và hiển thị"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"singular"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# shortNames cho phép dùng tên ngắn trên CLI"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"shortNames"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" cd\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# danh sách các version được hỗ trợ bởi CRD này"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"versions"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" v1\n      "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Mỗi version có thể bật/tắt bằng cờ Served."}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"served"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","boolean","important"]},"children":[{"type":"text","value":"true"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Chỉ một version được đánh dấu là storage version."}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"storage"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","boolean","important"]},"children":[{"type":"text","value":"true"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"schema"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"openAPIV3Schema"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" object\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"properties"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" object\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"properties"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n                "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"length"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n                  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" integer\n                "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"delay"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n                  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" integer\n                "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n                  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" string\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"additionalPrinterColumns"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Length\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" integer\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"description"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Độ dài của countdown\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"jsonPath"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" .spec.length\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Delay\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" integer\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"description"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Khoảng thời gian (ms) giữa các lần thực thi\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"jsonPath"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" .spec.delay"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bây giờ chúng ta có thể tạo Countdown của riêng mình:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"countdown.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" stable.dwk/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Countdown\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" doomsday\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"length"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"20"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"delay"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1200"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app10"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"sha"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"84d581d"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Và sau đó:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -f countdown.yaml\n  countdown.stable.dwk/doomsday created\n\n$ kubectl get "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"cd"}]},{"type":"text","value":"\n  NAME        LENGTH   DELAY\n  doomsday    "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"20"}]},{"type":"text","value":"       "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1200"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bây giờ chúng ta đã có một resource mới. Tiếp theo, hãy tạo một "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-controllers","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"custom controller"}]},{"type":"text","value":" mới sẽ khởi động một pod chạy container từ image và đảm bảo countdowns được xóa sau khi hoàn thành. Việc này sẽ cần phải code."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Để triển khai, tôi quyết định dùng "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/workloads/controllers/job/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Job"}]},{"type":"text","value":", một resource quen thuộc từ "},{"type":"element","tagName":"a","properties":{"href":"part-2/4-statefulsets-and-jobs#jobs-and-cronjobs"},"children":[{"type":"text","value":"phần 2"}]},{"type":"text","value":".\nCác pod do Job tạo ra sẽ chạy một lần cho đến khi hoàn thành. Tuy nhiên, cả Job đã hoàn thành lẫn Pod sẽ không tự động bị xóa. Chúng được giữ lại để có thể xem log sau khi thực thi."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Controller của chúng ta cần làm 3 việc:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tạo một Job từ một Countdown"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Lên lịch lại Job cho đến khi số lần thực thi (length) trong Countdown hoàn thành"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Xóa toàn bộ Job và Pod sau khi hoàn thành"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Để triển khai controller, chúng ta cần thao tác cấp thấp và truy cập trực tiếp Kubernetes qua REST API."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bằng cách lắng nghe API Kubernetes tại "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/apis/stable.dwk/v1/countdowns?watch=true"}]},{"type":"text","value":" chúng ta sẽ nhận được sự kiện ADDED cho mỗi Countdown object trong cụm. Sau đó, tạo job bằng cách phân tích dữ liệu từ message và POST payload hợp lệ tới "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/apis/batch/v1/namespaces/<namespace>/jobs"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Với job, chúng ta sẽ lắng nghe "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/apis/batch/v1/jobs?watch=true"}]},{"type":"text","value":" và chờ sự kiện MODIFIED khi trạng thái thành công được đặt thành true, rồi cập nhật label cho job để lưu trạng thái. Để xóa Job và Pod, gửi request delete tới "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/api/v1/namespaces/<namespace>/pods/<pod_name>"}]},{"type":"text","value":" và "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/apis/batch/v1/namespaces/<namespace>/jobs/<job_name>"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cuối cùng, có thể xóa countdown bằng request delete tới "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/apis/stable.dwk/v1/namespaces/<namespace>/countdowns/<countdown_name>"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Một phiên bản controller này có tại "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app10","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"đây"}]},{"type":"text","value":". Đã có sẵn image "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"jakousa/dwk-app10-controller:sha-4256579"}]},{"type":"text","value":". Tuy nhiên không thể chỉ deploy là chạy được vì nó chưa có quyền truy cập API. Chúng ta cần định nghĩa quyền truy cập phù hợp."}]},{"type":"element","tagName":"h2","properties":{"id":"rbac","style":"position:relative;"},"children":[{"type":"text","value":"RBAC"},{"type":"element","tagName":"a","properties":{"href":"#rbac","ariaLabel":"rbac permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"RBAC (Role-based access control) là phương pháp phân quyền cho phép định nghĩa quyền truy cập cho từng user, service account hoặc nhóm thông qua các role. Với trường hợp này, chúng ta sẽ định nghĩa một resource ServiceAccount."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"serviceaccount.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ServiceAccount\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"account"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"và sau đó chỉ định "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"serviceAccountName"}]},{"type":"text","value":" cho deployment"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"serviceAccountName"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"account\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app10"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"sha"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4256579"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tiếp theo là định nghĩa role và các rule của nó. Có hai loại role: "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ClusterRole"}]},{"type":"text","value":" và "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Role"}]},{"type":"text","value":". Role chỉ áp dụng cho một namespace, còn ClusterRole có thể truy cập tất cả namespace - trong trường hợp này, controller sẽ truy cập tất cả countdown ở mọi namespace nên cần ClusterRole."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Các rule được định nghĩa với apiGroup, resource và verbs. Ví dụ, jobs là "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/apis/batch/v1/jobs?watch=true"}]},{"type":"text","value":" nên thuộc apiGroup \"batch\", resource \"jobs\" và verbs xem "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"tài liệu"}]},{"type":"text","value":". Core API group là chuỗi rỗng \"\" như với pods."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"clusterrole.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ClusterRole\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" rbac.authorization.k8s.io/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"role\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"rules"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiGroups"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ở cấp HTTP, resource để truy cập Pod là \"pods\""}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"resources"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"pods\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"verbs"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"get\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"list\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"delete\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiGroups"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"batch\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ở cấp HTTP, resource để truy cập Job là \"jobs\""}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"resources"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"jobs\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"verbs"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"get\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"list\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"watch\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"create\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"delete\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiGroups"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"stable.dwk\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"resources"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"countdowns\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"verbs"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"get\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"list\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"watch\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"create\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"delete\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Và cuối cùng là bind ServiceAccount với role. Có hai loại binding: "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ClusterRoleBinding"}]},{"type":"text","value":" và "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"RoleBinding"}]},{"type":"text","value":". Nếu dùng "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"RoleBinding"}]},{"type":"text","value":" với "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ClusterRole"}]},{"type":"text","value":" thì chỉ giới hạn quyền trong một namespace. Ví dụ, nếu quyền truy cập secrets được định nghĩa ở ClusterRole và gán qua "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"RoleBinding"}]},{"type":"text","value":" cho namespace \"test\", thì chỉ truy cập được secrets trong namespace \"test\" - dù role là ClusterRole."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ở đây cần "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ClusterRoleBinding"}]},{"type":"text","value":" vì controller cần truy cập tất cả namespace từ namespace nó được deploy (ở đây là \"default\")."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"clusterrolebinding.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" rbac.authorization.k8s.io/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ClusterRoleBinding\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"rolebinding\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"roleRef"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiGroup"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" rbac.authorization.k8s.io\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ClusterRole\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"role\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"subjects"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ServiceAccount\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" countdown"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"controller"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"account\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"namespace"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" default"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Sau khi deploy tất cả, có thể kiểm tra log sau khi apply countdown. (Có thể cần xóa pod để nó restart nếu trước đó chưa có quyền và bị treo)"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl logs countdown-controller-dep-7ff598ffbf-q2rp5\n  "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" app10@1.0.0 start /usr/src/app\n  "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" node index.js\n\n  Scheduling new job number "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"20"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"for"}]},{"type":"text","value":" countdown doomsday to namespace default\n  Scheduling new job number "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"19"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"for"}]},{"type":"text","value":" countdown doomsday to namespace default\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":".."}]},{"type":"text","value":".\n  Countdown ended. Removing countdown.\n  Doing cleanup"}]}]}]},{"type":"element","tagName":"text-box","properties":{"name":"Chọn ngôn ngữ cho CRDs","variant":"hint"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ví dụ controller countdown được cài đặt theo hai cách: dùng "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app10-go","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Go"}]},{"type":"text","value":" và "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app10","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"JavaScript"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lựa chọn tốt nhất có lẽ là "},{"type":"element","tagName":"a","properties":{"href":"https://go.dev/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Go"}]},{"type":"text","value":" nhưng đây có thể không phải nơi phù hợp để học ngôn ngữ mới. README của "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app10-go","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"app10-go"}]},{"type":"text","value":" có hướng dẫn bắt đầu với CRD bằng Go!"}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 5.01: Tự làm CRD & Controller"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bài tập này không phụ thuộc vào các bài trước. Bạn có thể chọn bất kỳ công nghệ nào để triển khai."}]},{"type":"text","value":"  "},{"type":"element","tagName":"p","properties":{"style":"color:firebrick;"},"children":[{"type":"text","value":"Bài này khó!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chúng ta cần một resource "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"DummySite"}]},{"type":"text","value":" có thể dùng để tạo một trang HTML từ bất kỳ URL nào."}]},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tạo resource \"DummySite\" có thuộc tính chuỗi \"website_url\"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tạo controller nhận object \"DummySite\" được tạo từ API"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Controller tạo tất cả resource cần thiết cho chức năng này."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tham khảo "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/kubernetes-api/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://kubernetes.io/docs/reference/kubernetes-api/"}]},{"type":"text","value":" và "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/using-api/api-concepts/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://kubernetes.io/docs/reference/using-api/api-concepts/"}]},{"type":"text","value":" để biết thêm về API Kubernetes, và\n"},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/using-api/client-libraries/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://kubernetes.io/docs/reference/using-api/client-libraries/"}]},{"type":"text","value":" về các thư viện client."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bạn cũng có thể tham khảo các ví dụ ứng dụng: "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app10","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"js"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app10-go","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"go"}]},{"type":"text","value":". Lưu ý ứng dụng JavaScript không tận dụng hết tính năng của "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-client/javascript","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Kubernetes Client"}]},{"type":"text","value":", mà gọi trực tiếp REST API."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kiểm tra rằng khi tạo DummySite với website_url \""},{"type":"element","tagName":"a","properties":{"href":"https://example.com/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://example.com/"}]},{"type":"text","value":"\"\nsẽ tạo một bản sao của website đó. Với website phức tạp, \"bản sao\" không cần hoàn chỉnh. Ví dụ với "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Kubernetes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://en.wikipedia.org/wiki/Kubernetes"}]},{"type":"text","value":" CSS có thể bị lỗi:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/609f88728f7f5dea2774c347ef555dde/b8bf8/wikipedia.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 64.34782608695653%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAABYlAAAWJQFJUiTwAAACF0lEQVQoz41Py4rUQBTND/kN4k5w7Uq/xIUgIvRiwI0oLl2IuBIEdZCxQVFQYWZ6ksqrU0klqVSSzrOSSlWn8+i2GHAhiM7hcrhVl3POvYoQXd8LIbZFQau6zfIWRwWOsk3WNO22ZTvWDazbtWxkbMyKHW8iwZJ0k9dVoWhaqKpY0/rzVWMYBQC5rm8MQwAtsizkOERVhapOmkoBaFzYIZ+QOAmCIMtzBePK90vPK3w/whiHYQQhiWQ4lo20E5bFAeCWVSPUdh1rmobzjnPOGFOiKAxDFEUBIUT6EZLY9qiqhzBsKeVFceB8u91SxhohOKVUiiVLpWQFIRQEYRD40oIQmSyfrvxx3dayRs8TjiNsu4/j0nHqOCZJkuBLTNOk2LYBoQ1hoOvENEPbJpYlCzsOvLgIVitsGAiAAELXNC3btgEAum4AcIFQpECY+EHmoRLola7XQC80rTTNynXT31tgzws8z03TVMbK6+I4xpg3Ta8YRuYj6rlDmQ+0mmk9bTZjmg6yqorWdS3PlFSWpdxzf4l5nvte8kHxfbh20Y9TWlCxm4du203jcLgalN24f7LMHr0LF8f+3Qfo+p03qrmWg2ma93/ib+JherFcPz4OFyfZ7fv42q2fp2YuB/O8/3/yMAzLV89OXj798vHD0eLoxs17hpteVTxN4/n3z2dfP63Pvi3fv339/CF2QU3bLMu6rvu3+BewTcHEZ9bu9QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/609f88728f7f5dea2774c347ef555dde/a0b58/wikipedia.webp 230w","/static/609f88728f7f5dea2774c347ef555dde/bc10c/wikipedia.webp 460w","/static/609f88728f7f5dea2774c347ef555dde/966d8/wikipedia.webp 920w","/static/609f88728f7f5dea2774c347ef555dde/445df/wikipedia.webp 1380w","/static/609f88728f7f5dea2774c347ef555dde/eaa3b/wikipedia.webp 1728w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/609f88728f7f5dea2774c347ef555dde/81c8e/wikipedia.png 230w","/static/609f88728f7f5dea2774c347ef555dde/08a84/wikipedia.png 460w","/static/609f88728f7f5dea2774c347ef555dde/c0255/wikipedia.png 920w","/static/609f88728f7f5dea2774c347ef555dde/b1001/wikipedia.png 1380w","/static/609f88728f7f5dea2774c347ef555dde/b8bf8/wikipedia.png 1728w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/609f88728f7f5dea2774c347ef555dde/c0255/wikipedia.png","alt":"wikipedia","title":"wikipedia","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Controller không cần hoạt động hoàn hảo trong mọi trường hợp. Quy trình sau nên thành công:"}]},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"apply role, account và binding."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"apply deployment."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"apply DummySite"}]},{"type":"text","value":"\n"}]}]}]},"html":"<div><text-box variant='learningObjectives' name='Mục tiêu học tập'><p>Sau phần này, bạn có thể</p><ul>\n<li>Tạo Định nghĩa Tài nguyên Tùy chỉnh (Custom Resource Definitions) của riêng mình</li>\n</ul></text-box><p><a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\" target=\"_blank\" rel=\"noopener noreferrer\">Custom Resource Definitions</a> (CRDs) là cách để mở rộng Kubernetes với các tài nguyên (Resource) của riêng chúng ta. Chúng ta đã sử dụng rất nhiều CRD rồi, ví dụ ở <a href=\"/part-4/3-gitops\">phần 4</a> chúng ta đã dùng <a href=\"https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#applications\" target=\"_blank\" rel=\"noopener noreferrer\">Application</a> với ArgoCD.</p><p>Chúng là một phần không thể thiếu khi sử dụng Kubernetes nên rất đáng để học cách tự tạo một CRD.</p><p>Trước khi bắt đầu, chúng ta cần xác định mình muốn tạo gì. Hãy tạo một resource có thể dùng để tạo các bộ đếm ngược (countdown). Resource này sẽ tên là \"Countdown\". Nó sẽ có thuộc tính <em>length</em> (độ dài) và <em>delay</em> (khoảng thời gian giữa các lần thực thi). Việc thực thi - tức là mỗi lần <em>delay</em> trôi qua sẽ làm gì - sẽ do một image quyết định. Như vậy, ai đó dùng CRD của chúng ta có thể tạo một countdown mà mỗi lần đếm sẽ, ví dụ, đăng một tin lên Twitter.</p><p>Làm mẫu, tôi sẽ dùng template từ <a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/\" target=\"_blank\" rel=\"noopener noreferrer\">tài liệu</a>.</p><p><strong>resourcedefinition.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apiextensions.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> CustomResourceDefinition\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># name phải khớp với các trường spec bên dưới, và có dạng: &lt;plural>.&lt;group></span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdowns.stable.dwk\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># group name dùng cho REST API: /apis/&lt;group>/&lt;version></span>\n  <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> stable.dwk\n  <span class=\"token comment\"># hoặc Namespaced hoặc Cluster</span>\n  <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span> Namespaced\n  <span class=\"token key atrule\">names</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># kind thường là dạng CamelCase số ít. Resource manifest sẽ dùng trường này.</span>\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Countdown\n    <span class=\"token comment\"># plural dùng trong URL: /apis/&lt;group>/&lt;version>/&lt;plural></span>\n    <span class=\"token key atrule\">plural</span><span class=\"token punctuation\">:</span> countdowns\n    <span class=\"token comment\"># singular dùng làm alias trên CLI và hiển thị</span>\n    <span class=\"token key atrule\">singular</span><span class=\"token punctuation\">:</span> countdown\n    <span class=\"token comment\"># shortNames cho phép dùng tên ngắn trên CLI</span>\n    <span class=\"token key atrule\">shortNames</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> cd\n  <span class=\"token comment\"># danh sách các version được hỗ trợ bởi CRD này</span>\n  <span class=\"token key atrule\">versions</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> v1\n      <span class=\"token comment\"># Mỗi version có thể bật/tắt bằng cờ Served.</span>\n      <span class=\"token key atrule\">served</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token comment\"># Chỉ một version được đánh dấu là storage version.</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">schema</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">openAPIV3Schema</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n          <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n              <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">length</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> integer\n                <span class=\"token key atrule\">delay</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> integer\n                <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> string\n      <span class=\"token key atrule\">additionalPrinterColumns</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Length\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> integer\n          <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> Độ dài của countdown\n          <span class=\"token key atrule\">jsonPath</span><span class=\"token punctuation\">:</span> .spec.length\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Delay\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> integer\n          <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> Khoảng thời gian (ms) giữa các lần thực thi\n          <span class=\"token key atrule\">jsonPath</span><span class=\"token punctuation\">:</span> .spec.delay</code></pre></div><p>Bây giờ chúng ta có thể tạo Countdown của riêng mình:</p><p><strong>countdown.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> stable.dwk/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Countdown\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> doomsday\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">length</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span>\n  <span class=\"token key atrule\">delay</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1200</span>\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app10<span class=\"token punctuation\">:</span>sha<span class=\"token punctuation\">-</span>84d581d</code></pre></div><p>Và sau đó:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -f countdown.yaml\n  countdown.stable.dwk/doomsday created\n\n$ kubectl get <span class=\"token builtin class-name\">cd</span>\n  NAME        LENGTH   DELAY\n  doomsday    <span class=\"token number\">20</span>       <span class=\"token number\">1200</span></code></pre></div><p>Bây giờ chúng ta đã có một resource mới. Tiếp theo, hãy tạo một <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-controllers\" target=\"_blank\" rel=\"noopener noreferrer\">custom controller</a> mới sẽ khởi động một pod chạy container từ image và đảm bảo countdowns được xóa sau khi hoàn thành. Việc này sẽ cần phải code.</p><p>Để triển khai, tôi quyết định dùng <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/job/\" target=\"_blank\" rel=\"noopener noreferrer\">Job</a>, một resource quen thuộc từ <a href=\"part-2/4-statefulsets-and-jobs#jobs-and-cronjobs\">phần 2</a>.\nCác pod do Job tạo ra sẽ chạy một lần cho đến khi hoàn thành. Tuy nhiên, cả Job đã hoàn thành lẫn Pod sẽ không tự động bị xóa. Chúng được giữ lại để có thể xem log sau khi thực thi.</p><p>Controller của chúng ta cần làm 3 việc:</p><ul>\n<li>Tạo một Job từ một Countdown</li>\n<li>Lên lịch lại Job cho đến khi số lần thực thi (length) trong Countdown hoàn thành</li>\n<li>Xóa toàn bộ Job và Pod sau khi hoàn thành</li>\n</ul><p>Để triển khai controller, chúng ta cần thao tác cấp thấp và truy cập trực tiếp Kubernetes qua REST API.</p><p>Bằng cách lắng nghe API Kubernetes tại <code class=\"language-text\">/apis/stable.dwk/v1/countdowns?watch=true</code> chúng ta sẽ nhận được sự kiện ADDED cho mỗi Countdown object trong cụm. Sau đó, tạo job bằng cách phân tích dữ liệu từ message và POST payload hợp lệ tới <code class=\"language-text\">/apis/batch/v1/namespaces/&lt;namespace&gt;/jobs</code>.</p><p>Với job, chúng ta sẽ lắng nghe <code class=\"language-text\">/apis/batch/v1/jobs?watch=true</code> và chờ sự kiện MODIFIED khi trạng thái thành công được đặt thành true, rồi cập nhật label cho job để lưu trạng thái. Để xóa Job và Pod, gửi request delete tới <code class=\"language-text\">/api/v1/namespaces/&lt;namespace&gt;/pods/&lt;pod_name&gt;</code> và <code class=\"language-text\">/apis/batch/v1/namespaces/&lt;namespace&gt;/jobs/&lt;job_name&gt;</code></p><p>Cuối cùng, có thể xóa countdown bằng request delete tới <code class=\"language-text\">/apis/stable.dwk/v1/namespaces/&lt;namespace&gt;/countdowns/&lt;countdown_name&gt;</code>.</p><p>Một phiên bản controller này có tại <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app10\" target=\"_blank\" rel=\"noopener noreferrer\">đây</a>. Đã có sẵn image <code class=\"language-text\">jakousa/dwk-app10-controller:sha-4256579</code>. Tuy nhiên không thể chỉ deploy là chạy được vì nó chưa có quyền truy cập API. Chúng ta cần định nghĩa quyền truy cập phù hợp.</p><h2 id=\"rbac\" style=\"position:relative;\">RBAC<a href=\"#rbac\" aria-label=\"rbac permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2><p>RBAC (Role-based access control) là phương pháp phân quyền cho phép định nghĩa quyền truy cập cho từng user, service account hoặc nhóm thông qua các role. Với trường hợp này, chúng ta sẽ định nghĩa một resource ServiceAccount.</p><p><strong>serviceaccount.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller<span class=\"token punctuation\">-</span>account</code></pre></div><p>và sau đó chỉ định <em>serviceAccountName</em> cho deployment</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller<span class=\"token punctuation\">-</span>account\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app10<span class=\"token punctuation\">-</span>controller<span class=\"token punctuation\">:</span>sha<span class=\"token punctuation\">-</span><span class=\"token number\">4256579</span></code></pre></div><p>Tiếp theo là định nghĩa role và các rule của nó. Có hai loại role: <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole\" target=\"_blank\" rel=\"noopener noreferrer\">ClusterRole</a> và <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole\" target=\"_blank\" rel=\"noopener noreferrer\">Role</a>. Role chỉ áp dụng cho một namespace, còn ClusterRole có thể truy cập tất cả namespace - trong trường hợp này, controller sẽ truy cập tất cả countdown ở mọi namespace nên cần ClusterRole.</p><p>Các rule được định nghĩa với apiGroup, resource và verbs. Ví dụ, jobs là <code class=\"language-text\">/apis/batch/v1/jobs?watch=true</code> nên thuộc apiGroup \"batch\", resource \"jobs\" và verbs xem <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb\" target=\"_blank\" rel=\"noopener noreferrer\">tài liệu</a>. Core API group là chuỗi rỗng \"\" như với pods.</p><p><strong>clusterrole.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller<span class=\"token punctuation\">-</span>role\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># ở cấp HTTP, resource để truy cập Pod là \"pods\"</span>\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"pods\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"batch\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># ở cấp HTTP, resource để truy cập Job là \"jobs\"</span>\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"jobs\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"create\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"stable.dwk\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"countdowns\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"create\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">]</span></code></pre></div><p>Và cuối cùng là bind ServiceAccount với role. Có hai loại binding: <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings\" target=\"_blank\" rel=\"noopener noreferrer\">ClusterRoleBinding</a> và <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings\" target=\"_blank\" rel=\"noopener noreferrer\">RoleBinding</a>. Nếu dùng <em>RoleBinding</em> với <em>ClusterRole</em> thì chỉ giới hạn quyền trong một namespace. Ví dụ, nếu quyền truy cập secrets được định nghĩa ở ClusterRole và gán qua <em>RoleBinding</em> cho namespace \"test\", thì chỉ truy cập được secrets trong namespace \"test\" - dù role là ClusterRole.</p><p>Ở đây cần <em>ClusterRoleBinding</em> vì controller cần truy cập tất cả namespace từ namespace nó được deploy (ở đây là \"default\").</p><p><strong>clusterrolebinding.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRoleBinding\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>rolebinding\n<span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io\n  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller<span class=\"token punctuation\">-</span>role\n<span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> countdown<span class=\"token punctuation\">-</span>controller<span class=\"token punctuation\">-</span>account\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default</code></pre></div><p>Sau khi deploy tất cả, có thể kiểm tra log sau khi apply countdown. (Có thể cần xóa pod để nó restart nếu trước đó chưa có quyền và bị treo)</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl logs countdown-controller-dep-7ff598ffbf-q2rp5\n  <span class=\"token operator\">></span> app10@1.0.0 start /usr/src/app\n  <span class=\"token operator\">></span> node index.js\n\n  Scheduling new job number <span class=\"token number\">20</span> <span class=\"token keyword\">for</span> countdown doomsday to namespace default\n  Scheduling new job number <span class=\"token number\">19</span> <span class=\"token keyword\">for</span> countdown doomsday to namespace default\n  <span class=\"token punctuation\">..</span>.\n  Countdown ended. Removing countdown.\n  Doing cleanup</code></pre></div><text-box name=\"Chọn ngôn ngữ cho CRDs\" variant=\"hint\"><p>Ví dụ controller countdown được cài đặt theo hai cách: dùng <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app10-go\" target=\"_blank\" rel=\"noopener noreferrer\">Go</a> và <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app10\" target=\"_blank\" rel=\"noopener noreferrer\">JavaScript</a>.</p><p>Lựa chọn tốt nhất có lẽ là <a href=\"https://go.dev/\" target=\"_blank\" rel=\"noopener noreferrer\">Go</a> nhưng đây có thể không phải nơi phù hợp để học ngôn ngữ mới. README của <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app10-go\" target=\"_blank\" rel=\"noopener noreferrer\">app10-go</a> có hướng dẫn bắt đầu với CRD bằng Go!</p></text-box><exercise name='Bài tập 5.01: Tự làm CRD & Controller'><p>Bài tập này không phụ thuộc vào các bài trước. Bạn có thể chọn bất kỳ công nghệ nào để triển khai.</p>  <p style=\"color:firebrick;\">Bài này khó!</p><p>Chúng ta cần một resource <em>DummySite</em> có thể dùng để tạo một trang HTML từ bất kỳ URL nào.</p><ol>\n<li>Tạo resource \"DummySite\" có thuộc tính chuỗi \"website_url\".</li>\n<li>Tạo controller nhận object \"DummySite\" được tạo từ API</li>\n<li>Controller tạo tất cả resource cần thiết cho chức năng này.</li>\n</ol><p>Tham khảo <a href=\"https://kubernetes.io/docs/reference/kubernetes-api/\" target=\"_blank\" rel=\"noopener noreferrer\">https://kubernetes.io/docs/reference/kubernetes-api/</a> và <a href=\"https://kubernetes.io/docs/reference/using-api/api-concepts/\" target=\"_blank\" rel=\"noopener noreferrer\">https://kubernetes.io/docs/reference/using-api/api-concepts/</a> để biết thêm về API Kubernetes, và\n<a href=\"https://kubernetes.io/docs/reference/using-api/client-libraries/\" target=\"_blank\" rel=\"noopener noreferrer\">https://kubernetes.io/docs/reference/using-api/client-libraries/</a> về các thư viện client.</p><p>Bạn cũng có thể tham khảo các ví dụ ứng dụng: <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app10\" target=\"_blank\" rel=\"noopener noreferrer\">js</a>, <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app10-go\" target=\"_blank\" rel=\"noopener noreferrer\">go</a>. Lưu ý ứng dụng JavaScript không tận dụng hết tính năng của <a href=\"https://github.com/kubernetes-client/javascript\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes Client</a>, mà gọi trực tiếp REST API.</p><p>Kiểm tra rằng khi tạo DummySite với website_url \"<a href=\"https://example.com/\" target=\"_blank\" rel=\"noopener noreferrer\">https://example.com/</a>\"\nsẽ tạo một bản sao của website đó. Với website phức tạp, \"bản sao\" không cần hoàn chỉnh. Ví dụ với <a href=\"https://en.wikipedia.org/wiki/Kubernetes\" target=\"_blank\" rel=\"noopener noreferrer\">https://en.wikipedia.org/wiki/Kubernetes</a> CSS có thể bị lỗi:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/609f88728f7f5dea2774c347ef555dde/b8bf8/wikipedia.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 64.34782608695653%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAABYlAAAWJQFJUiTwAAACF0lEQVQoz41Py4rUQBTND/kN4k5w7Uq/xIUgIvRiwI0oLl2IuBIEdZCxQVFQYWZ6ksqrU0klqVSSzrOSSlWn8+i2GHAhiM7hcrhVl3POvYoQXd8LIbZFQau6zfIWRwWOsk3WNO22ZTvWDazbtWxkbMyKHW8iwZJ0k9dVoWhaqKpY0/rzVWMYBQC5rm8MQwAtsizkOERVhapOmkoBaFzYIZ+QOAmCIMtzBePK90vPK3w/whiHYQQhiWQ4lo20E5bFAeCWVSPUdh1rmobzjnPOGFOiKAxDFEUBIUT6EZLY9qiqhzBsKeVFceB8u91SxhohOKVUiiVLpWQFIRQEYRD40oIQmSyfrvxx3dayRs8TjiNsu4/j0nHqOCZJkuBLTNOk2LYBoQ1hoOvENEPbJpYlCzsOvLgIVitsGAiAAELXNC3btgEAum4AcIFQpECY+EHmoRLola7XQC80rTTNynXT31tgzws8z03TVMbK6+I4xpg3Ta8YRuYj6rlDmQ+0mmk9bTZjmg6yqorWdS3PlFSWpdxzf4l5nvte8kHxfbh20Y9TWlCxm4du203jcLgalN24f7LMHr0LF8f+3Qfo+p03qrmWg2ma93/ib+JherFcPz4OFyfZ7fv42q2fp2YuB/O8/3/yMAzLV89OXj798vHD0eLoxs17hpteVTxN4/n3z2dfP63Pvi3fv339/CF2QU3bLMu6rvu3+BewTcHEZ9bu9QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/609f88728f7f5dea2774c347ef555dde/a0b58/wikipedia.webp 230w,\n/static/609f88728f7f5dea2774c347ef555dde/bc10c/wikipedia.webp 460w,\n/static/609f88728f7f5dea2774c347ef555dde/966d8/wikipedia.webp 920w,\n/static/609f88728f7f5dea2774c347ef555dde/445df/wikipedia.webp 1380w,\n/static/609f88728f7f5dea2774c347ef555dde/eaa3b/wikipedia.webp 1728w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/609f88728f7f5dea2774c347ef555dde/81c8e/wikipedia.png 230w,\n/static/609f88728f7f5dea2774c347ef555dde/08a84/wikipedia.png 460w,\n/static/609f88728f7f5dea2774c347ef555dde/c0255/wikipedia.png 920w,\n/static/609f88728f7f5dea2774c347ef555dde/b1001/wikipedia.png 1380w,\n/static/609f88728f7f5dea2774c347ef555dde/b8bf8/wikipedia.png 1728w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/609f88728f7f5dea2774c347ef555dde/c0255/wikipedia.png\" alt=\"wikipedia\" title=\"wikipedia\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Controller không cần hoạt động hoàn hảo trong mọi trường hợp. Quy trình sau nên thành công:</p><ol>\n<li>apply role, account và binding.</li>\n<li>apply deployment.</li>\n<li>apply DummySite</li>\n</ol></exercise></div>","frontmatter":{"path":"/part-5/2-custom-resource-definitions-vi","title":"Định nghĩa Tài nguyên Tùy chỉnh (Custom Resource Definitions)"},"fileAbsolutePath":"/home/runner/work/dwk2024/dwk2024/data/part-5/2-custom-resource-definitions-vi.md"},"allPages":{"edges":[{"node":{"id":"7e706a38-3828-5118-bdec-3705a319a1b0","frontmatter":{"path":"/faq-vi","title":"Câu hỏi thường gặp"}}},{"node":{"id":"5225f2a2-20f9-50ce-93ac-7b38f3105103","frontmatter":{"path":"/faq","title":"FAQ"}}},{"node":{"id":"e1ed6713-5992-5f7f-95a1-17efd97f57d8","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"04c5ddbd-7839-580f-82da-bc9fdbb49f84","frontmatter":{"path":"/known-problems-solutions-vi","title":"Các vấn đề bạn có thể gặp phải"}}},{"node":{"id":"3102d88f-7297-56fb-af03-27d1079fffd1","frontmatter":{"path":"/","title":"Trang chủ"}}},{"node":{"id":"c92ea568-3384-5ff8-8dfa-b9015597780d","frontmatter":{"path":"/known-problems-solutions","title":"Issues you may face"}}},{"node":{"id":"52d4cd1d-eb14-54f3-a18a-ef84b67c320d","frontmatter":{"path":"/index-en","title":"Homepage"}}},{"node":{"id":"5e6b6ee0-b381-53f0-b84c-af378792b131","frontmatter":{"path":"/registration-and-completion","title":"Registration and Completion"}}},{"node":{"id":"58688080-4aa8-54e6-8b8b-02de1c4f6410","frontmatter":{"path":"/unity-assignment","title":"Unity Assignment"}}},{"node":{"id":"d9c993b6-f6b4-59a1-b119-f3b7218eec6b","frontmatter":{"path":"/sanasto","title":"Sanasto"}}},{"node":{"id":"8a3ee5be-7557-5fcd-954b-2351e74cd585","frontmatter":{"path":"/part-0/1-intro-vi","title":"Giới thiệu khóa học"}}},{"node":{"id":"23082016-7bbd-5215-8485-4ffccbf3ea1a","frontmatter":{"path":"/part-0/1-intro","title":"Course Introduction"}}},{"node":{"id":"771eaa93-2ef2-5e0f-9e1e-55914c67c4ac","frontmatter":{"path":"/part-0","title":"Part 0"}}},{"node":{"id":"fe0342aa-a4c5-5b44-8591-71eb27f1a287","frontmatter":{"path":"/part-1/2-introduction-to-debugging-vi","title":"Giới thiệu về Debugging"}}},{"node":{"id":"1c236933-7ad5-5b61-8c07-07db3822d55a","frontmatter":{"path":"/part-1/2-introduction-to-debugging","title":"Introduction to Debugging"}}},{"node":{"id":"3c788edf-62db-5e86-9366-17b53eda9244","frontmatter":{"path":"/part-1/5-summary","title":"Summary"}}},{"node":{"id":"8ed3365b-b788-5806-8ec5-bec3cb0f94c8","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"7fc5c062-6b94-53ec-9aaa-adca66ce672e","frontmatter":{"path":"/part-1/5-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"46a4a0e4-d131-537d-aa72-5b6726163a7d","frontmatter":{"path":"/part-2/1-networking-between-pods-vi","title":"Kết nối mạng giữa các pod"}}},{"node":{"id":"fd467661-6b24-545f-904c-52f4a7ade6b7","frontmatter":{"path":"/part-2/1-networking-between-pods","title":"Networking between pods"}}},{"node":{"id":"56110eda-875d-5bd9-a400-5bd5a009df7f","frontmatter":{"path":"/part-2/5-monitoring-vi","title":"Giám sát"}}},{"node":{"id":"8f3387b0-ec6e-5a86-982a-e52780d911f9","frontmatter":{"path":"/part-2/5-monitoring","title":"Monitoring"}}},{"node":{"id":"06173ac4-c2f8-57df-8dc8-450b5c2bb695","frontmatter":{"path":"/part-2/6-summary","title":"Summary"}}},{"node":{"id":"79f1cddb-6995-51c2-bf98-2adc13de9b13","frontmatter":{"path":"/part-2/6-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"8c3d747d-4f87-5a46-99ac-dfd0af5a893b","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"8d9fd774-9dbe-5cca-8395-9226fcf82c4a","frontmatter":{"path":"/part-3/4-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"b98b2895-6c9d-5234-939d-2f547cbf8a06","frontmatter":{"path":"/part-3/4-summary","title":"Summary"}}},{"node":{"id":"29bec4f5-8a0b-580d-ac84-9dbbd1d7152e","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"4dd8302d-d170-5d38-8198-4d0947322bbc","frontmatter":{"path":"/part-4/4-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"0045695d-e541-5acc-b4b8-551023d01733","frontmatter":{"path":"/part-4/4-summary","title":"Summary"}}},{"node":{"id":"a917b24d-df2b-5199-ac98-cd0f7560c63f","frontmatter":{"path":"/part-4","title":"Part 4"}}},{"node":{"id":"eb339401-26c8-594c-98fd-2f30a95275cd","frontmatter":{"path":"/part-5/4-beyond-kubernetes-vi","title":"Vượt ra ngoài Kubernetes"}}},{"node":{"id":"2318c18f-86e6-5a4e-958a-d1c38f8615cd","frontmatter":{"path":"/part-5/4-beyond-kubernetes","title":"Beyond Kubernetes"}}},{"node":{"id":"781bd207-902e-59a2-a752-4958c2c93fb0","frontmatter":{"path":"/part-5/5-summary-vi","title":"Tóm tắt và kết thúc"}}},{"node":{"id":"1d8ff75c-065b-565d-9ceb-01b9a276ae7a","frontmatter":{"path":"/part-5/5-summary","title":"Summary and end"}}},{"node":{"id":"829fd216-f995-5a77-b201-bb971aec73b4","frontmatter":{"path":"/part-0/2-kubernetes-in-three-diagrams-vi","title":"Kubernetes qua ba sơ đồ"}}},{"node":{"id":"98132cca-4dc3-5942-a6f4-1da87bc81a23","frontmatter":{"path":"/part-0/2-kubernetes-in-three-diagrams","title":"Kubernetes in three diagrams"}}},{"node":{"id":"90b8e83a-9d55-550a-908a-316708ce7f8c","frontmatter":{"path":"/part-1/3-introduction-to-networking","title":"Introduction to Networking"}}},{"node":{"id":"8931bcb7-c40e-5d57-aa80-c4333972fbb8","frontmatter":{"path":"/part-1/3-introduction-to-networking-vi","title":"Giới thiệu về Mạng"}}},{"node":{"id":"4fe00c0a-bb17-5d4c-8202-750493a755c9","frontmatter":{"path":"/part-1/4-introduction-to-storage-vi","title":"Giới thiệu về Lưu trữ"}}},{"node":{"id":"6cc3be66-6091-58fc-bcbd-1f27f9473f85","frontmatter":{"path":"/part-1/4-introduction-to-storage","title":"Introduction to Storage"}}},{"node":{"id":"b53df746-c24f-57e3-a9f3-d6d621697689","frontmatter":{"path":"/part-2/2-organizing-a-cluster-vi","title":"Tổ chức một cụm"}}},{"node":{"id":"d5206d16-d2fe-51fd-8acd-d85ecf0be257","frontmatter":{"path":"/part-2/2-organizing-a-cluster","title":"Organizing a cluster"}}},{"node":{"id":"15be3d7c-b0b7-5bce-b3bf-8cec39d54630","frontmatter":{"path":"/part-2/3-configuring-applications-vi","title":"Cấu hình ứng dụng"}}},{"node":{"id":"e4534a9d-fb84-5d1f-83f0-35055feb0da7","frontmatter":{"path":"/part-2/3-configuring-applications","title":"Configuring applications"}}},{"node":{"id":"466aa711-527b-55a0-871b-13468e65d344","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs","title":"StatefulSets and Jobs"}}},{"node":{"id":"02389078-a12f-561a-8a54-fa99a6950b92","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs-vi","title":"StatefulSet và Job"}}},{"node":{"id":"bea18f34-dcdc-59b8-ba24-3011680a0c58","frontmatter":{"path":"/part-3/1-introduction-to-gke-vi","title":"Giới thiệu về Google Kubernetes Engine"}}},{"node":{"id":"84db9628-b3df-5ca1-9d3d-5924e02ae549","frontmatter":{"path":"/part-3/1-introduction-to-gke","title":"Introduction to Google Kubernetes Engine"}}},{"node":{"id":"0049e57f-0bc7-5689-9169-43848a972877","frontmatter":{"path":"/part-3/2-deployment-pipeline-vi","title":"Quy trình Triển khai (Deployment Pipeline)"}}},{"node":{"id":"61f18dc7-1abf-5c75-9b54-0cee11c76a40","frontmatter":{"path":"/part-3/2-deployment-pipeline","title":"Deployment Pipeline"}}},{"node":{"id":"7dfec8c7-8ccb-50da-949d-ebd1de395dc4","frontmatter":{"path":"/part-3/3-gke-features-vi","title":"Các tính năng của GKE"}}},{"node":{"id":"423cbc46-2dfa-57e6-9dc5-761a93729600","frontmatter":{"path":"/part-3/3-gke-features","title":"GKE features"}}},{"node":{"id":"6df9c7be-f930-5827-a39c-0c1698b23600","frontmatter":{"path":"/part-4/3-gitops-vi","title":"Triển khai GitOps"}}},{"node":{"id":"46f9ce68-5ccd-5787-bd59-03852ad6fdcb","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"31927db3-2182-55c7-b680-663754461d14","frontmatter":{"path":"/part-5/1-kubernetes-internals","title":"Kubernetes Internals"}}},{"node":{"id":"68c64f9f-c9a5-544b-bafb-b061665cacd0","frontmatter":{"path":"/part-5/3-service-mesh-vi","title":"Service Mesh"}}},{"node":{"id":"da1f8069-17bc-5c8e-9310-117bcedf5acf","frontmatter":{"path":"/part-5/2-custom-resource-definitions-vi","title":"Định nghĩa Tài nguyên Tùy chỉnh (Custom Resource Definitions)"}}},{"node":{"id":"0e981ec1-99e0-5005-ba9f-4f626a81b7ce","frontmatter":{"path":"/part-5/1-kubernetes-internals-vi","title":"Bên trong Kubernetes"}}},{"node":{"id":"ccefb04a-5790-57f6-869b-d255b2203667","frontmatter":{"path":"/part-5/2-custom-resource-definitions","title":"Custom Resource Definitions"}}},{"node":{"id":"20ceed4e-761d-54d4-9acf-2669eac533c6","frontmatter":{"path":"/part-5/3-service-mesh","title":"Service Mesh"}}},{"node":{"id":"306c87f3-9adb-5d8b-a3ce-072f8e6cfa43","frontmatter":{"path":"/part-5","title":"Part 5"}}},{"node":{"id":"97ead58a-8493-5fdd-808e-d4a56de573b0","frontmatter":{"path":"/part-1/1-first-deploy","title":"First Deploy"}}},{"node":{"id":"c179c521-bb62-52bd-808b-d4869df5302a","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus-vi","title":"Chiến lược cập nhật và Prometheus"}}},{"node":{"id":"898b0354-f1a2-5664-97de-d84b16018395","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"}}},{"node":{"id":"6f4f18ce-5aa9-5bb5-9d74-0a631a78e6b3","frontmatter":{"path":"/part-4/2-messaging-systems-vi","title":"Hệ thống nhắn tin"}}},{"node":{"id":"6981a9d7-619d-51a9-9490-74bc77c0f55b","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"}}},{"node":{"id":"a17c4c44-7396-543f-b6b4-7adf57808aa8","frontmatter":{"path":"/part-1/1-first-deploy-vi","title":"Triển khai đầu tiên"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}