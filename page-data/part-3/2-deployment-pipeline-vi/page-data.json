{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-3/2-deployment-pipeline-vi","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Mục tiêu học tập"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Sau phần này bạn có thể"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Tạo quy trình triển khai của riêng bạn lên GKE với Github Actions và kích hoạt triển khai liên tục từ một lần đẩy mã (git push) lên môi trường sản xuất"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Hãy thiết lập một quy trình triển khai sử dụng GitHub Actions. Chúng ta chỉ cần một thứ gì đó để triển khai nên hãy tạo một website mới."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tạo một Dockerfile với nội dung sau:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"1.19"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alpine\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" index.html /usr/share/nginx/html"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"và thêm file index.html với nội dung sau"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"html"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-html"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-html"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","doctype"]},"children":[{"type":"text","value":"<!DOCTYPE html>"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"html"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"body"}]},{"type":"element","tagName":"span","properties":{"className":["token","style-attr","language-css"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","attr-name"]},"children":[{"type":"text","value":"style"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"=\""}]},{"type":"element","tagName":"span","properties":{"className":["token","attr-value"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"background-color"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" gray"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"p"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n      Nội dung\n    "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"p"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"body"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","tag"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"</"}]},{"type":"text","value":"html"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":">"}]}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Hãy đảm bảo mọi thứ hoạt động bằng cách thực hiện "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker build . -t colorcontent && docker run -p 3000:80 colorcontent"}]},{"type":"text","value":" để build và chạy nó, sau đó truy cập "},{"type":"element","tagName":"a","properties":{"href":"http://localhost:3000","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://localhost:3000"}]},{"type":"text","value":". Tiếp theo là thêm các manifest cho website của chúng ta."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"manifests/service.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Service\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"svc\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"type"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" LoadBalancer\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"80"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"protocol"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" TCP\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"targetPort"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"80"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"manifests/deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/colorcontent"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tiếp theo, để kiểm tra manifest, hãy triển khai nó vào cụm của chúng ta. Ở trên tôi đã đẩy image đã build bằng "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker push"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -f manifests/service.yaml\n$ kubectl apply -f manifests/deployment.yaml"}]}]}]},{"type":"element","tagName":"h3","properties":{"id":"kustomize","style":"position:relative;"},"children":[{"type":"text","value":"Kustomize"},{"type":"element","tagName":"a","properties":{"href":"#kustomize","ariaLabel":"kustomize permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Áp dụng nhiều file như vậy khá phiền phức. Chúng ta có thể chỉ định một thư mục như sau: "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl apply -f manifests/"}]},{"type":"text","value":", nhưng đây là thời điểm tuyệt vời để chú ý đến Kustomize."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-sigs/kustomize","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Kustomize"}]},{"type":"text","value":" là một công cụ giúp tùy biến cấu hình và đã được tích hợp sẵn trong kubectl. Trong trường hợp này, chúng ta sẽ dùng nó để xác định những file nào là quan trọng với Kubernetes. Ngoài ra, chúng ta có thể dùng Helm và có thể là "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/Praqma/helmsman","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Helmsman"}]},{"type":"text","value":", nhưng sẽ không đề cập trong phạm vi khóa học này."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Với chúng ta, một file mới "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"kustomization.yaml"}]},{"type":"text","value":" ở thư mục gốc của dự án là đủ. File "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"kustomization.yaml"}]},{"type":"text","value":" nên bao gồm hướng dẫn sử dụng deployment.yaml và service.yaml."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"kustomization.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" kustomize.config.k8s.io/v1beta1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Kustomization\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"resources"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" manifests/deployment.yaml\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" manifests/service.yaml"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bây giờ chúng ta có thể triển khai bằng cờ "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"-k"}]},{"type":"text","value":" để chỉ định sử dụng Kustomize."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -k "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"."}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chúng ta có thể xem trước file với "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl kustomize ."}]},{"type":"text","value":". Kustomize sẽ là công cụ thiết yếu cho quy trình triển khai của chúng ta. Nó cho phép chúng ta chọn riêng lẻ image nào sẽ sử dụng. Để làm điều này, hãy khai báo image trong kustomization.yaml."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"kustomization.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"images"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" PROJECT/IMAGE\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"newName"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/colorcontent"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Điều này sẽ thay thế image \"IMAGE:TAG\" bằng image được định nghĩa trong "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"newName"}]},{"type":"text","value":". Tiếp theo, đặt một giá trị placeholder trong deployment.yaml cho image:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" PROJECT/IMAGE"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kiểm tra mọi thứ hoạt động"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl kustomize "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":".."}]},{"type":"text","value":".\n    spec:\n      containers:\n      - image: jakousa/colorcontent\n        name: dwk-environments"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kustomize còn có một số công cụ bổ sung bạn có thể thử nếu muốn cài đặt - nhưng chúng ta sẽ thấy cách sử dụng ở phần tiếp theo."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tài liệu của Kustomize có thể không phải là tốt nhất. Bạn sẽ tìm thấy nhiều thông tin hữu ích hơn qua Google. Một tài liệu bạn nên xem là "},{"type":"element","tagName":"a","properties":{"href":"https://itnext.io/kubernetes-kustomize-cheat-sheet-8e2d31b74d8f","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Kustomize Cheat Sheet"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"h3","properties":{"id":"github-actions","style":"position:relative;"},"children":[{"type":"text","value":"Github Actions"},{"type":"element","tagName":"a","properties":{"href":"#github-actions","ariaLabel":"github actions permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://github.com/features/actions","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"GitHub Actions"}]},{"type":"text","value":" sẽ là công cụ CI/CD được lựa chọn cho khóa học này. Google cũng cung cấp "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/cloud-build","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Cloud Build"}]},{"type":"text","value":", và một "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/cloud-build/docs/deploying-builds/deploy-gke","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"hướng dẫn từng bước triển khai lên GKE"}]},{"type":"text","value":" với nó. Bạn có thể quay lại đây để triển khai với Cloud Build nếu còn dư tín dụng sau khóa học!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tạo file .github/workflows/main.yaml. Chúng ta muốn workflow thực hiện 3 việc:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"build image"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"publish image lên container registry"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"triển khai image mới lên cụm của chúng ta"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cấu hình ban đầu sẽ như sau:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"main.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Release application\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"on"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"push"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"PROJECT_ID"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" $"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" secrets.GKE_PROJECT "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"GKE_CLUSTER"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"cluster\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"GKE_ZONE"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" europe"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"north1"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"b\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"IMAGE"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"SERVICE"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"BRANCH"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" $"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" github.ref_name "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chúng ta thiết lập workflow chạy mỗi khi có thay đổi được đẩy lên repository và đặt các biến môi trường phù hợp - chúng ta sẽ cần chúng ở các bước sau."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tiếp theo là thêm các job. Để đơn giản, chúng ta sẽ thêm mọi thứ vào một job duy nhất để build, publish và deploy."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"jobs"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"build-publish-deploy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Build"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" Publish and Deploy\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"runs-on"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ubuntu"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"latest\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"steps"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Checkout\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" actions/checkout@v4"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Điều này thiết lập môi trường cho job và kích hoạt "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/actions/checkout","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"checkout action"}]},{"type":"text","value":" ở bước đầu tiên."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tiếp theo, chúng ta sẽ sử dụng một số action bổ sung, chủ yếu từ "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/google-github-actions","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"google-github-actions"}]},{"type":"text","value":" được thiết kế để hỗ trợ triển khai lên Google Cloud. Bắt đầu với "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/google-github-actions/auth","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"authentication"}]},{"type":"text","value":", tiếp theo là "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/google-github-actions/setup-gcloud","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"setup"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" google"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"github"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"actions/auth@v2\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"with"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"credentials_json"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ secrets.GKE_SA_KEY }}\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Set up Cloud SDK\""}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" google"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"github"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"actions/setup"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"gcloud@v2\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Use gcloud CLI\""}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" gcloud info"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Các secrets dùng cho xác thực "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"không"}]},{"type":"text","value":" lấy từ biến môi trường mà được thêm vào secrets của dự án trên GitHub:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/1ee612ce2bb9a06525c53d042b427ada/82747/ghasecret.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 62.173913043478265%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmklEQVQoz41Sy67UMAzN/wvxBYh/YM8CiT9AYoEQdzHt9JHm4TyapEnTcjKF0bDDOqqcuLbPscPIOG0sQNZLRfhqsoqs1A8fUbLGtUutNJ/mrewplwssxpTSdv61WqtsJpQUWslxHFOKLXAcF/DD8TDcMedR1ZRSruSy7/dhvA3ibTA37rrZDIvlfFkWAUwzn6aJcz5zjp4shCikJGOuYjnn7j7/6uXPTr3dFZckJD24KGstkbEP896DAnPrqpTetvyH9nFYZ1fvggcnuNa59gkhgG/d6/lizK8Bsp9n9LctwRvrUPv81xBNW0anLWcIZEqT1voZhvhhnOZ5gTzn17LXLZcQkVLgx5S5UMA4C2M9knXf90/aqD1zIaQCyb0eLWHbtV2RCx+oBzZycCGt8wz0iOiVIQpBybUNYD/OS+l1hPBciw8+bYmhAAaO/V3bgpLbrQPnceLohvm1tSKjEWk1vg0/3n358P7rx0/fP2NVQWvy6wrnoq3wrHyTialA6iswJXKOa0XB+xTZIqnr73gAMcb6eEDnf9tvjOayfz571ikAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/1ee612ce2bb9a06525c53d042b427ada/a0b58/ghasecret.webp 230w","/static/1ee612ce2bb9a06525c53d042b427ada/bc10c/ghasecret.webp 460w","/static/1ee612ce2bb9a06525c53d042b427ada/966d8/ghasecret.webp 920w","/static/1ee612ce2bb9a06525c53d042b427ada/445df/ghasecret.webp 1380w","/static/1ee612ce2bb9a06525c53d042b427ada/78de1/ghasecret.webp 1840w","/static/1ee612ce2bb9a06525c53d042b427ada/81416/ghasecret.webp 2232w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/1ee612ce2bb9a06525c53d042b427ada/81c8e/ghasecret.png 230w","/static/1ee612ce2bb9a06525c53d042b427ada/08a84/ghasecret.png 460w","/static/1ee612ce2bb9a06525c53d042b427ada/c0255/ghasecret.png 920w","/static/1ee612ce2bb9a06525c53d042b427ada/b1001/ghasecret.png 1380w","/static/1ee612ce2bb9a06525c53d042b427ada/161ec/ghasecret.png 1840w","/static/1ee612ce2bb9a06525c53d042b427ada/82747/ghasecret.png 2232w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/1ee612ce2bb9a06525c53d042b427ada/c0255/ghasecret.png","alt":"ghasecret","title":"ghasecret","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Đọc thêm "},{"type":"element","tagName":"a","properties":{"href":"https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"tại đây"}]},{"type":"text","value":" về GitHub secrets."}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"GKE"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"SA"}]},{"type":"text","value":"KEY là "},{"type":"element","tagName":"i","properties":{},"children":[{"type":"text","value":"khóa tài khoản dịch vụ"}]},{"type":"text","value":" cần thiết để truy cập dịch vụ Google Cloud - đọc hướng dẫn "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/iam/docs/creating-managing-service-account-keys","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"tại đây"}]},{"type":"text","value":". Bạn sẽ cần tạo một tài khoản dịch vụ mới và lấy khóa của nó."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cấp các quyền sau cho tài khoản dịch vụ:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Kubernetes Engine Service Agent"}]},{"type":"text","value":" - Cho phép tài khoản Kubernetes Engine quản lý tài nguyên cụm. Bao gồm quyền truy cập tài khoản dịch vụ."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Storage Admin"}]},{"type":"text","value":" - Toàn quyền kiểm soát bucket và object."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Artifact Registry Administrator"}]},{"type":"text","value":" - Quản trị viên tạo và quản lý repository."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Artifact Registry Create-on-Push Repository Administrator"}]},{"type":"text","value":" - Quản lý artifact trong repository, cũng như tạo repository mới khi push."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Sau khi tạo tài khoản dịch vụ cho GKE tên \"github-actions\", tôi tạo khóa bằng gcloud:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ gcloud iam service-accounts keys create ./private-key.json --iam-account"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":"github-actions@dwk-gke-331210.iam.gserviceaccount.com"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Toàn bộ file JSON sinh ra cần được thêm vào GKE"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"SA"}]},{"type":"text","value":"KEY."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tiếp theo, dùng lệnh "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"gcloud"}]},{"type":"text","value":" để cấu hình Docker."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" gcloud "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"quiet auth configure"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"docker"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Điều này cho phép chúng ta push image lên Google Container Registry, thay vì Docker Hub. Chúng ta có thể dùng Docker Hub nếu muốn, nhưng GCR là lựa chọn tuyệt vời khi đã có quyền truy cập. GCR hiệu năng cao và độ trễ mạng thấp. Giảm thời gian di chuyển image sẽ giúp triển khai nhanh hơn. Đọc thêm tại "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/container-registry/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://cloud.google.com/container-registry/"}]},{"type":"text","value":". Lưu ý registry này "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/container-registry/pricing","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"không miễn phí"}]},{"type":"text","value":" và bạn nên xóa image trong và sau khóa học."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Còn một bước nữa là sử dụng action\n"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/google-github-actions/get-gke-credentials","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"get-gke-credentials"}]},{"type":"text","value":" để lấy thông tin xác thực cụm Google Kubernetes:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Get GKE credentials\""}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"google-github-actions/get-gke-credentials@v2\""}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"with"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"cluster_name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ env.GKE_CLUSTER }}\""}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"project_id"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ env.PROJECT_ID }}\""}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"location"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ env.GKE_ZONE }}\""}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Và cuối cùng, hãy ghi ra image mong muốn với tag. Image sẽ là "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"gcr.io/PROJECT_ID/IMAGE:GITHUB_BRANCH-GITHUB_SHA"}]},{"type":"text","value":". Và build image:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Build\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" docker build "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"tag \"gcr.io/$PROJECT_ID/$IMAGE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"$BRANCH"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"$GITHUB_SHA\" ."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chúng ta dùng tên dự án (từ env "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"$IMAGE"}]},{"type":"text","value":") làm tên image và tag là tên nhánh cộng với commit "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"sha"}]},{"type":"text","value":" từ env "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"$GITHUB"}]},{"type":"text","value":"SHA_ do workflow cung cấp tự động."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Publish tương tự:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Publish\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" docker push \"gcr.io/$PROJECT_ID/$IMAGE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"$BRANCH"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"$GITHUB_SHA\""}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bước cuối là triển khai. Đầu tiên thiết lập Kustomize:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Set up Kustomize\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" imranismail/setup"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"kustomize@v2.1.0"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bây giờ chúng ta có thể dùng Kustomize để đặt image mà pipeline sẽ publish. Ở đây tôi pipe output của "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kustomize build ."}]},{"type":"text","value":" vào "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl apply"}]},{"type":"text","value":", nếu bạn không chắc chuyện gì đang xảy ra, có thể xuất "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kustomize build ."}]},{"type":"text","value":" ra để kiểm tra giữa pipeline!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cuối cùng, chúng ta sẽ xem trước "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/kubectl/generated/kubectl_rollout/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"rollout"}]},{"type":"text","value":" và xác nhận release thành công. Rollout sẽ chờ đến khi deployment hoàn tất. Ở đây chúng ta dùng cùng tên image, dwk-environments, làm tên deployment nên có thể dùng biến môi trường $IMAGE."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deploy\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"\n    kustomize edit set image PROJECT/IMAGE=gcr.io/$PROJECT_ID/$IMAGE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"$BRANCH"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"$GITHUB_SHA\n    kustomize build . "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" kubectl apply "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"f "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"\n    kubectl rollout status deployment $SERVICE\n    kubectl get services "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"o wide"}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 3.03: Dự án v1.4"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Thiết lập triển khai tự động cho dự án."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Gợi ý:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Nếu pod của bạn dùng Persistent Volume Claim với access mode "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ReadWriteOnce"}]},{"type":"text","value":", bạn có thể cần cân nhắc "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"chiến lược triển khai"}]},{"type":"text","value":", vì mặc định (RollingUpdate) có thể gây lỗi. Đọc thêm trong "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"tài liệu"}]},{"type":"text","value":". Lựa chọn khác là dùng "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"access mode"}]},{"type":"text","value":" cho phép nhiều pod mount volume."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Nếu bạn dùng Ingress, nhớ rằng nó mong đợi service trả về phản hồi thành công tại đường dẫn / dù service được ánh xạ tới đường dẫn khác!"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"h3","properties":{"id":"moi-trường-rieng-cho-mỗi-nhanh","style":"position:relative;"},"children":[{"type":"text","value":"Môi trường riêng cho mỗi nhánh"},{"type":"element","tagName":"a","properties":{"href":"#moi-tr%C6%B0%E1%BB%9Dng-rieng-cho-m%E1%BB%97i-nhanh","ariaLabel":"moi trường rieng cho mỗi nhanh permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Một lựa chọn phổ biến khi dùng pipeline triển khai là có môi trường riêng cho mỗi nhánh - đặc biệt khi dùng feature branching."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Hãy triển khai phiên bản của riêng chúng ta. Hãy mở rộng pipeline đã định nghĩa trước đó. Trạng thái hiện tại của pipeline như sau:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"main.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Release application\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"on"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"push"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"PROJECT_ID"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" $"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" secrets.GKE_PROJECT "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"GKE_CLUSTER"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"cluster\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"GKE_ZONE"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" europe"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"north1"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"b\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"IMAGE"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"DEPLOYMENT"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"environments\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"BRANCH"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" $"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" github.ref_name "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"jobs"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"build-publish-deploy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Build"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" Publish and Deploy\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"runs-on"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ubuntu"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"latest\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"steps"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Checkout\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" actions/checkout@v4\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" google"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"github"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"actions/auth@v2\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"with"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"credentials_json"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ secrets.GKE_SA_KEY }}\""}]},{"type":"text","value":"\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Set up Cloud SDK\""}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" google"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"github"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"actions/setup"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"gcloud@v2\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Use gcloud CLI\""}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" gcloud info\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" gcloud "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"quiet auth configure"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"docker\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Get GKE credentials\""}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"google-github-actions/get-gke-credentials@v2\""}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"with"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"cluster_name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ env.GKE_CLUSTER }}\""}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"project_id"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ env.PROJECT_ID }}\""}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"location"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${{ env.GKE_ZONE }}\""}]},{"type":"text","value":"\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Build and publish\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"\n          docker build "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"tag \"gcr.io/$PROJECT_ID/$IMAGE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"$BRANCH"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"$GITHUB_SHA\" .\n          docker push \"gcr.io/$PROJECT_ID/$IMAGE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"$BRANCH"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"$GITHUB_SHA\"\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Set up Kustomize\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"uses"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" imranismail/setup"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"kustomize@v2\n\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deploy\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"\n          kustomize edit set image PROJECT/IMAGE=gcr.io/$PROJECT_ID/$IMAGE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"$BRANCH"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"$GITHUB_SHA\n          kustomize build . "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" kubectl apply "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"f "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"\n          kubectl rollout status deployment $DEPLOYMENT\n          kubectl get services "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"o wide"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chúng ta muốn triển khai mỗi nhánh vào một namespace riêng để mỗi nhánh có môi trường riêng biệt."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Namespace có thể thay đổi với kustomize:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"kustomize edit "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"set"}]},{"type":"text","value":" namespace "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${GITHUB_REF"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"#"}]},{"type":"text","value":"refs"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"heads"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Với lệnh này, tên namespace sẽ bằng tên nhánh."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nếu namespace chưa tồn tại, lệnh sẽ báo lỗi, nên cần tạo namespace:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"kubectl create namespace "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${GITHUB_REF"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"#"}]},{"type":"text","value":"refs"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"heads"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"}"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"||"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","boolean"]},"children":[{"type":"text","value":"true"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chúng ta cũng cần đặt namespace cho context:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"kubectl config set-context --current --namespace"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${GITHUB_REF"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"#"}]},{"type":"text","value":"refs"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"heads"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"/"}]},{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Vậy bước deploy sẽ thay đổi như sau:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deploy\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"\n    kubectl create namespace $"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"GITHUB_REF"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#refs/heads/} || true"}]},{"type":"text","value":"\n    kubectl config set"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"context "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"current "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"namespace=$"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"GITHUB_REF"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#refs/heads/}"}]},{"type":"text","value":"\n    kustomize edit set namespace $"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"GITHUB_REF"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#refs/heads/}"}]},{"type":"text","value":"\n    kustomize edit set image PROJECT/IMAGE=gcr.io/$PROJECT_ID/$IMAGE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"$"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"GITHUB_REF"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#refs/heads/}-$GITHUB_SHA"}]},{"type":"text","value":"\n    kustomize build . "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" kubectl apply "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"f "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"\n    kubectl rollout status deployment $DEPLOYMENT\n    kubectl get services "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"o wide"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Để kiểm tra, hãy sửa index.html và đẩy thay đổi lên một nhánh mới."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bước tiếp theo là cấu hình tên miền cho từng nhánh để có \"www.example.com\" cho production và ví dụ \"feat"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"x.example.com\" cho nhánh feat"}]},{"type":"text","value":"x. Nếu còn dư tín dụng sau khóa học, bạn có thể quay lại đây để triển khai. Google Cloud DNS và "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/kubernetes-engine/docs/tutorials/configuring-domain-name-static-ip","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"hướng dẫn này"}]},{"type":"text","value":" sẽ giúp bạn bắt đầu."}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 3.04: Dự án v1.4.1"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cải tiến quy trình triển khai để mỗi nhánh tạo một môi trường riêng. Nhánh main vẫn phải được triển khai ở namespace "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"default"}]},{"type":"text","value":"."}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 3.05: Dự án v1.4.2"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cuối cùng, hãy tạo workflow mới để khi xóa một nhánh thì môi trường tương ứng cũng bị xóa."}]}]}]},"html":"<div><text-box variant='learningObjectives' name='Mục tiêu học tập'><p>Sau phần này bạn có thể</p><ul>\n<li>Tạo quy trình triển khai của riêng bạn lên GKE với Github Actions và kích hoạt triển khai liên tục từ một lần đẩy mã (git push) lên môi trường sản xuất</li>\n</ul></text-box><p>Hãy thiết lập một quy trình triển khai sử dụng GitHub Actions. Chúng ta chỉ cần một thứ gì đó để triển khai nên hãy tạo một website mới.</p><p>Tạo một Dockerfile với nội dung sau:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> nginx<span class=\"token punctuation\">:</span>1.19<span class=\"token punctuation\">-</span>alpine\n\n<span class=\"token keyword\">COPY</span> index.html /usr/share/nginx/html</code></pre></div><p>và thêm file index.html với nội dung sau</p><div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\">&lt;!DOCTYPE html></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"> <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> gray<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span>\n      Nội dung\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div><p>Hãy đảm bảo mọi thứ hoạt động bằng cách thực hiện <code class=\"language-text\">docker build . -t colorcontent &amp;&amp; docker run -p 3000:80 colorcontent</code> để build và chạy nó, sau đó truy cập <a href=\"http://localhost:3000\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:3000</a>. Tiếp theo là thêm các manifest cho website của chúng ta.</p><p><strong>manifests/service.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments<span class=\"token punctuation\">-</span>svc\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div><p><strong>manifests/deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/colorcontent</code></pre></div><p>Tiếp theo, để kiểm tra manifest, hãy triển khai nó vào cụm của chúng ta. Ở trên tôi đã đẩy image đã build bằng <code class=\"language-text\">docker push</code>.</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -f manifests/service.yaml\n$ kubectl apply -f manifests/deployment.yaml</code></pre></div><h3 id=\"kustomize\" style=\"position:relative;\">Kustomize<a href=\"#kustomize\" aria-label=\"kustomize permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Áp dụng nhiều file như vậy khá phiền phức. Chúng ta có thể chỉ định một thư mục như sau: <code class=\"language-text\">kubectl apply -f manifests/</code>, nhưng đây là thời điểm tuyệt vời để chú ý đến Kustomize.</p><p><a href=\"https://github.com/kubernetes-sigs/kustomize\" target=\"_blank\" rel=\"noopener noreferrer\">Kustomize</a> là một công cụ giúp tùy biến cấu hình và đã được tích hợp sẵn trong kubectl. Trong trường hợp này, chúng ta sẽ dùng nó để xác định những file nào là quan trọng với Kubernetes. Ngoài ra, chúng ta có thể dùng Helm và có thể là <a href=\"https://github.com/Praqma/helmsman\" target=\"_blank\" rel=\"noopener noreferrer\">Helmsman</a>, nhưng sẽ không đề cập trong phạm vi khóa học này.</p><p>Với chúng ta, một file mới <em>kustomization.yaml</em> ở thư mục gốc của dự án là đủ. File <em>kustomization.yaml</em> nên bao gồm hướng dẫn sử dụng deployment.yaml và service.yaml.</p><p><strong>kustomization.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kustomize.config.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Kustomization\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> manifests/deployment.yaml\n  <span class=\"token punctuation\">-</span> manifests/service.yaml</code></pre></div><p>Bây giờ chúng ta có thể triển khai bằng cờ <code class=\"language-text\">-k</code> để chỉ định sử dụng Kustomize.</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -k <span class=\"token builtin class-name\">.</span></code></pre></div><p>Chúng ta có thể xem trước file với <code class=\"language-text\">kubectl kustomize .</code>. Kustomize sẽ là công cụ thiết yếu cho quy trình triển khai của chúng ta. Nó cho phép chúng ta chọn riêng lẻ image nào sẽ sử dụng. Để làm điều này, hãy khai báo image trong kustomization.yaml.</p><p><strong>kustomization.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token key atrule\">images</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> PROJECT/IMAGE\n    <span class=\"token key atrule\">newName</span><span class=\"token punctuation\">:</span> jakousa/colorcontent</code></pre></div><p>Điều này sẽ thay thế image \"IMAGE:TAG\" bằng image được định nghĩa trong <em>newName</em>. Tiếp theo, đặt một giá trị placeholder trong deployment.yaml cho image:</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> PROJECT/IMAGE</code></pre></div><p>Kiểm tra mọi thứ hoạt động</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl kustomize <span class=\"token builtin class-name\">.</span>\n  <span class=\"token punctuation\">..</span>.\n    spec:\n      containers:\n      - image: jakousa/colorcontent\n        name: dwk-environments</code></pre></div><p>Kustomize còn có một số công cụ bổ sung bạn có thể thử nếu muốn cài đặt - nhưng chúng ta sẽ thấy cách sử dụng ở phần tiếp theo.</p><p>Tài liệu của Kustomize có thể không phải là tốt nhất. Bạn sẽ tìm thấy nhiều thông tin hữu ích hơn qua Google. Một tài liệu bạn nên xem là <a href=\"https://itnext.io/kubernetes-kustomize-cheat-sheet-8e2d31b74d8f\" target=\"_blank\" rel=\"noopener noreferrer\">Kustomize Cheat Sheet</a>.</p><h3 id=\"github-actions\" style=\"position:relative;\">Github Actions<a href=\"#github-actions\" aria-label=\"github actions permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p><a href=\"https://github.com/features/actions\" target=\"_blank\" rel=\"noopener noreferrer\">GitHub Actions</a> sẽ là công cụ CI/CD được lựa chọn cho khóa học này. Google cũng cung cấp <a href=\"https://cloud.google.com/cloud-build\" target=\"_blank\" rel=\"noopener noreferrer\">Cloud Build</a>, và một <a href=\"https://cloud.google.com/cloud-build/docs/deploying-builds/deploy-gke\" target=\"_blank\" rel=\"noopener noreferrer\">hướng dẫn từng bước triển khai lên GKE</a> với nó. Bạn có thể quay lại đây để triển khai với Cloud Build nếu còn dư tín dụng sau khóa học!</p><p>Tạo file .github/workflows/main.yaml. Chúng ta muốn workflow thực hiện 3 việc:</p><ul>\n<li>build image</li>\n<li>publish image lên container registry</li>\n<li>triển khai image mới lên cụm của chúng ta</li>\n</ul><p>Cấu hình ban đầu sẽ như sau:</p><p><strong>main.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Release application\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">PROJECT_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GKE_PROJECT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">GKE_CLUSTER</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>cluster\n  <span class=\"token key atrule\">GKE_ZONE</span><span class=\"token punctuation\">:</span> europe<span class=\"token punctuation\">-</span>north1<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">IMAGE</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n  <span class=\"token key atrule\">SERVICE</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n  <span class=\"token key atrule\">BRANCH</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref_name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div><p>Chúng ta thiết lập workflow chạy mỗi khi có thay đổi được đẩy lên repository và đặt các biến môi trường phù hợp - chúng ta sẽ cần chúng ở các bước sau.</p><p>Tiếp theo là thêm các job. Để đơn giản, chúng ta sẽ thêm mọi thứ vào một job duy nhất để build, publish và deploy.</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build-publish-deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build<span class=\"token punctuation\">,</span> Publish and Deploy\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4</code></pre></div><p>Điều này thiết lập môi trường cho job và kích hoạt <a href=\"https://github.com/actions/checkout\" target=\"_blank\" rel=\"noopener noreferrer\">checkout action</a> ở bước đầu tiên.</p><p>Tiếp theo, chúng ta sẽ sử dụng một số action bổ sung, chủ yếu từ <a href=\"https://github.com/google-github-actions\" target=\"_blank\" rel=\"noopener noreferrer\">google-github-actions</a> được thiết kế để hỗ trợ triển khai lên Google Cloud. Bắt đầu với <a href=\"https://github.com/google-github-actions/auth\" target=\"_blank\" rel=\"noopener noreferrer\">authentication</a>, tiếp theo là <a href=\"https://github.com/google-github-actions/setup-gcloud\" target=\"_blank\" rel=\"noopener noreferrer\">setup</a>:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> google<span class=\"token punctuation\">-</span>github<span class=\"token punctuation\">-</span>actions/auth@v2\n  <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">credentials_json</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ secrets.GKE_SA_KEY }}\"</span>\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Set up Cloud SDK\"</span>\n  <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> google<span class=\"token punctuation\">-</span>github<span class=\"token punctuation\">-</span>actions/setup<span class=\"token punctuation\">-</span>gcloud@v2\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Use gcloud CLI\"</span>\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gcloud info</code></pre></div><p>Các secrets dùng cho xác thực <strong>không</strong> lấy từ biến môi trường mà được thêm vào secrets của dự án trên GitHub:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/1ee612ce2bb9a06525c53d042b427ada/82747/ghasecret.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 62.173913043478265%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAABmklEQVQoz41Sy67UMAzN/wvxBYh/YM8CiT9AYoEQdzHt9JHm4TyapEnTcjKF0bDDOqqcuLbPscPIOG0sQNZLRfhqsoqs1A8fUbLGtUutNJ/mrewplwssxpTSdv61WqtsJpQUWslxHFOKLXAcF/DD8TDcMedR1ZRSruSy7/dhvA3ibTA37rrZDIvlfFkWAUwzn6aJcz5zjp4shCikJGOuYjnn7j7/6uXPTr3dFZckJD24KGstkbEP896DAnPrqpTetvyH9nFYZ1fvggcnuNa59gkhgG/d6/lizK8Bsp9n9LctwRvrUPv81xBNW0anLWcIZEqT1voZhvhhnOZ5gTzn17LXLZcQkVLgx5S5UMA4C2M9knXf90/aqD1zIaQCyb0eLWHbtV2RCx+oBzZycCGt8wz0iOiVIQpBybUNYD/OS+l1hPBciw8+bYmhAAaO/V3bgpLbrQPnceLohvm1tSKjEWk1vg0/3n358P7rx0/fP2NVQWvy6wrnoq3wrHyTialA6iswJXKOa0XB+xTZIqnr73gAMcb6eEDnf9tvjOayfz571ikAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/1ee612ce2bb9a06525c53d042b427ada/a0b58/ghasecret.webp 230w,\n/static/1ee612ce2bb9a06525c53d042b427ada/bc10c/ghasecret.webp 460w,\n/static/1ee612ce2bb9a06525c53d042b427ada/966d8/ghasecret.webp 920w,\n/static/1ee612ce2bb9a06525c53d042b427ada/445df/ghasecret.webp 1380w,\n/static/1ee612ce2bb9a06525c53d042b427ada/78de1/ghasecret.webp 1840w,\n/static/1ee612ce2bb9a06525c53d042b427ada/81416/ghasecret.webp 2232w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/1ee612ce2bb9a06525c53d042b427ada/81c8e/ghasecret.png 230w,\n/static/1ee612ce2bb9a06525c53d042b427ada/08a84/ghasecret.png 460w,\n/static/1ee612ce2bb9a06525c53d042b427ada/c0255/ghasecret.png 920w,\n/static/1ee612ce2bb9a06525c53d042b427ada/b1001/ghasecret.png 1380w,\n/static/1ee612ce2bb9a06525c53d042b427ada/161ec/ghasecret.png 1840w,\n/static/1ee612ce2bb9a06525c53d042b427ada/82747/ghasecret.png 2232w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/1ee612ce2bb9a06525c53d042b427ada/c0255/ghasecret.png\" alt=\"ghasecret\" title=\"ghasecret\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Đọc thêm <a href=\"https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets\" target=\"_blank\" rel=\"noopener noreferrer\">tại đây</a> về GitHub secrets.</p><div>GKE<em>SA</em>KEY là <i>khóa tài khoản dịch vụ</i> cần thiết để truy cập dịch vụ Google Cloud - đọc hướng dẫn <a href=\"https://cloud.google.com/iam/docs/creating-managing-service-account-keys\" target=\"_blank\" rel=\"noopener noreferrer\">tại đây</a>. Bạn sẽ cần tạo một tài khoản dịch vụ mới và lấy khóa của nó.</div><p>Cấp các quyền sau cho tài khoản dịch vụ:</p><ul>\n<li><strong>Kubernetes Engine Service Agent</strong> - Cho phép tài khoản Kubernetes Engine quản lý tài nguyên cụm. Bao gồm quyền truy cập tài khoản dịch vụ.</li>\n<li><strong>Storage Admin</strong> - Toàn quyền kiểm soát bucket và object.</li>\n<li><strong>Artifact Registry Administrator</strong> - Quản trị viên tạo và quản lý repository.</li>\n<li><strong>Artifact Registry Create-on-Push Repository Administrator</strong> - Quản lý artifact trong repository, cũng như tạo repository mới khi push.</li>\n</ul><p>Sau khi tạo tài khoản dịch vụ cho GKE tên \"github-actions\", tôi tạo khóa bằng gcloud:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ gcloud iam service-accounts keys create ./private-key.json --iam-account<span class=\"token operator\">=</span>github-actions@dwk-gke-331210.iam.gserviceaccount.com</code></pre></div><p>Toàn bộ file JSON sinh ra cần được thêm vào GKE<em>SA</em>KEY.</p><p>Tiếp theo, dùng lệnh <em>gcloud</em> để cấu hình Docker.</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gcloud <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>quiet auth configure<span class=\"token punctuation\">-</span>docker</code></pre></div><p>Điều này cho phép chúng ta push image lên Google Container Registry, thay vì Docker Hub. Chúng ta có thể dùng Docker Hub nếu muốn, nhưng GCR là lựa chọn tuyệt vời khi đã có quyền truy cập. GCR hiệu năng cao và độ trễ mạng thấp. Giảm thời gian di chuyển image sẽ giúp triển khai nhanh hơn. Đọc thêm tại <a href=\"https://cloud.google.com/container-registry/\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/container-registry/</a>. Lưu ý registry này <a href=\"https://cloud.google.com/container-registry/pricing\" target=\"_blank\" rel=\"noopener noreferrer\">không miễn phí</a> và bạn nên xóa image trong và sau khóa học.</p><p>Còn một bước nữa là sử dụng action\n<a href=\"https://github.com/google-github-actions/get-gke-credentials\" target=\"_blank\" rel=\"noopener noreferrer\">get-gke-credentials</a> để lấy thông tin xác thực cụm Google Kubernetes:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Get GKE credentials\"</span>\n  <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"google-github-actions/get-gke-credentials@v2\"</span>\n  <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">cluster_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ env.GKE_CLUSTER }}\"</span>\n    <span class=\"token key atrule\">project_id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ env.PROJECT_ID }}\"</span>\n    <span class=\"token key atrule\">location</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ env.GKE_ZONE }}\"</span></code></pre></div><p>Và cuối cùng, hãy ghi ra image mong muốn với tag. Image sẽ là <code class=\"language-text\">gcr.io/PROJECT_ID/IMAGE:GITHUB_BRANCH-GITHUB_SHA</code>. Và build image:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>tag \"gcr.io/$PROJECT_ID/$IMAGE<span class=\"token punctuation\">:</span>$BRANCH<span class=\"token punctuation\">-</span>$GITHUB_SHA\" .</code></pre></div><p>Chúng ta dùng tên dự án (từ env <em>$IMAGE</em>) làm tên image và tag là tên nhánh cộng với commit <em>sha</em> từ env <em>$GITHUB</em>SHA_ do workflow cung cấp tự động.</p><p>Publish tương tự:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker push \"gcr.io/$PROJECT_ID/$IMAGE<span class=\"token punctuation\">:</span>$BRANCH<span class=\"token punctuation\">-</span>$GITHUB_SHA\"</code></pre></div><p>Bước cuối là triển khai. Đầu tiên thiết lập Kustomize:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Kustomize\n  <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> imranismail/setup<span class=\"token punctuation\">-</span>kustomize@v2.1.0</code></pre></div><p>Bây giờ chúng ta có thể dùng Kustomize để đặt image mà pipeline sẽ publish. Ở đây tôi pipe output của <code class=\"language-text\">kustomize build .</code> vào <code class=\"language-text\">kubectl apply</code>, nếu bạn không chắc chuyện gì đang xảy ra, có thể xuất <code class=\"language-text\">kustomize build .</code> ra để kiểm tra giữa pipeline!</p><p>Cuối cùng, chúng ta sẽ xem trước <a href=\"https://kubernetes.io/docs/reference/kubectl/generated/kubectl_rollout/\" target=\"_blank\" rel=\"noopener noreferrer\">rollout</a> và xác nhận release thành công. Rollout sẽ chờ đến khi deployment hoàn tất. Ở đây chúng ta dùng cùng tên image, dwk-environments, làm tên deployment nên có thể dùng biến môi trường $IMAGE.</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\n    kustomize edit set image PROJECT/IMAGE=gcr.io/$PROJECT_ID/$IMAGE<span class=\"token punctuation\">:</span>$BRANCH<span class=\"token punctuation\">-</span>$GITHUB_SHA\n    kustomize build . <span class=\"token punctuation\">|</span> kubectl apply <span class=\"token punctuation\">-</span>f <span class=\"token punctuation\">-</span>\n    kubectl rollout status deployment $SERVICE\n    kubectl get services <span class=\"token punctuation\">-</span>o wide</code></pre></div><exercise name='Bài tập 3.03: Dự án v1.4'><p>Thiết lập triển khai tự động cho dự án.</p><p>Gợi ý:</p><ul>\n<li>Nếu pod của bạn dùng Persistent Volume Claim với access mode <a href=\"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes\" target=\"_blank\" rel=\"noopener noreferrer\">ReadWriteOnce</a>, bạn có thể cần cân nhắc <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy\" target=\"_blank\" rel=\"noopener noreferrer\">chiến lược triển khai</a>, vì mặc định (RollingUpdate) có thể gây lỗi. Đọc thêm trong <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy\" target=\"_blank\" rel=\"noopener noreferrer\">tài liệu</a>. Lựa chọn khác là dùng <a href=\"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes\" target=\"_blank\" rel=\"noopener noreferrer\">access mode</a> cho phép nhiều pod mount volume.</li>\n<li>Nếu bạn dùng Ingress, nhớ rằng nó mong đợi service trả về phản hồi thành công tại đường dẫn / dù service được ánh xạ tới đường dẫn khác!</li>\n</ul></exercise><h3 id=\"moi-trường-rieng-cho-mỗi-nhanh\" style=\"position:relative;\">Môi trường riêng cho mỗi nhánh<a href=\"#moi-tr%C6%B0%E1%BB%9Dng-rieng-cho-m%E1%BB%97i-nhanh\" aria-label=\"moi trường rieng cho mỗi nhanh permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Một lựa chọn phổ biến khi dùng pipeline triển khai là có môi trường riêng cho mỗi nhánh - đặc biệt khi dùng feature branching.</p><p>Hãy triển khai phiên bản của riêng chúng ta. Hãy mở rộng pipeline đã định nghĩa trước đó. Trạng thái hiện tại của pipeline như sau:</p><p><strong>main.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Release application\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">PROJECT_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GKE_PROJECT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">GKE_CLUSTER</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>cluster\n  <span class=\"token key atrule\">GKE_ZONE</span><span class=\"token punctuation\">:</span> europe<span class=\"token punctuation\">-</span>north1<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">IMAGE</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n  <span class=\"token key atrule\">DEPLOYMENT</span><span class=\"token punctuation\">:</span> dwk<span class=\"token punctuation\">-</span>environments\n  <span class=\"token key atrule\">BRANCH</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref_name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build-publish-deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build<span class=\"token punctuation\">,</span> Publish and Deploy\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> google<span class=\"token punctuation\">-</span>github<span class=\"token punctuation\">-</span>actions/auth@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">credentials_json</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ secrets.GKE_SA_KEY }}\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Set up Cloud SDK\"</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> google<span class=\"token punctuation\">-</span>github<span class=\"token punctuation\">-</span>actions/setup<span class=\"token punctuation\">-</span>gcloud@v2\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Use gcloud CLI\"</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gcloud info\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gcloud <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>quiet auth configure<span class=\"token punctuation\">-</span>docker\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Get GKE credentials\"</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"google-github-actions/get-gke-credentials@v2\"</span>\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">cluster_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ env.GKE_CLUSTER }}\"</span>\n          <span class=\"token key atrule\">project_id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ env.PROJECT_ID }}\"</span>\n          <span class=\"token key atrule\">location</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${{ env.GKE_ZONE }}\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and publish\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\n          docker build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>tag \"gcr.io/$PROJECT_ID/$IMAGE<span class=\"token punctuation\">:</span>$BRANCH<span class=\"token punctuation\">-</span>$GITHUB_SHA\" .\n          docker push \"gcr.io/$PROJECT_ID/$IMAGE<span class=\"token punctuation\">:</span>$BRANCH<span class=\"token punctuation\">-</span>$GITHUB_SHA\"\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Kustomize\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> imranismail/setup<span class=\"token punctuation\">-</span>kustomize@v2\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\n          kustomize edit set image PROJECT/IMAGE=gcr.io/$PROJECT_ID/$IMAGE<span class=\"token punctuation\">:</span>$BRANCH<span class=\"token punctuation\">-</span>$GITHUB_SHA\n          kustomize build . <span class=\"token punctuation\">|</span> kubectl apply <span class=\"token punctuation\">-</span>f <span class=\"token punctuation\">-</span>\n          kubectl rollout status deployment $DEPLOYMENT\n          kubectl get services <span class=\"token punctuation\">-</span>o wide</code></pre></div><p>Chúng ta muốn triển khai mỗi nhánh vào một namespace riêng để mỗi nhánh có môi trường riêng biệt.</p><p>Namespace có thể thay đổi với kustomize:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kustomize edit <span class=\"token builtin class-name\">set</span> namespace <span class=\"token variable\">${GITHUB_REF<span class=\"token operator\">#</span>refs<span class=\"token operator\">/</span>heads<span class=\"token operator\">/</span>}</span></code></pre></div><p>Với lệnh này, tên namespace sẽ bằng tên nhánh.</p><p>Nếu namespace chưa tồn tại, lệnh sẽ báo lỗi, nên cần tạo namespace:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl create namespace <span class=\"token variable\">${GITHUB_REF<span class=\"token operator\">#</span>refs<span class=\"token operator\">/</span>heads<span class=\"token operator\">/</span>}</span> <span class=\"token operator\">||</span> <span class=\"token boolean\">true</span></code></pre></div><p>Chúng ta cũng cần đặt namespace cho context:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">kubectl config set-context --current --namespace<span class=\"token operator\">=</span><span class=\"token variable\">${GITHUB_REF<span class=\"token operator\">#</span>refs<span class=\"token operator\">/</span>heads<span class=\"token operator\">/</span>}</span></code></pre></div><p>Vậy bước deploy sẽ thay đổi như sau:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\n    kubectl create namespace $<span class=\"token punctuation\">{</span>GITHUB_REF<span class=\"token comment\">#refs/heads/} || true</span>\n    kubectl config set<span class=\"token punctuation\">-</span>context <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>current <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>namespace=$<span class=\"token punctuation\">{</span>GITHUB_REF<span class=\"token comment\">#refs/heads/}</span>\n    kustomize edit set namespace $<span class=\"token punctuation\">{</span>GITHUB_REF<span class=\"token comment\">#refs/heads/}</span>\n    kustomize edit set image PROJECT/IMAGE=gcr.io/$PROJECT_ID/$IMAGE<span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span>GITHUB_REF<span class=\"token comment\">#refs/heads/}-$GITHUB_SHA</span>\n    kustomize build . <span class=\"token punctuation\">|</span> kubectl apply <span class=\"token punctuation\">-</span>f <span class=\"token punctuation\">-</span>\n    kubectl rollout status deployment $DEPLOYMENT\n    kubectl get services <span class=\"token punctuation\">-</span>o wide</code></pre></div><p>Để kiểm tra, hãy sửa index.html và đẩy thay đổi lên một nhánh mới.</p><p>Bước tiếp theo là cấu hình tên miền cho từng nhánh để có \"www.example.com\" cho production và ví dụ \"feat<em>x.example.com\" cho nhánh feat</em>x. Nếu còn dư tín dụng sau khóa học, bạn có thể quay lại đây để triển khai. Google Cloud DNS và <a href=\"https://cloud.google.com/kubernetes-engine/docs/tutorials/configuring-domain-name-static-ip\" target=\"_blank\" rel=\"noopener noreferrer\">hướng dẫn này</a> sẽ giúp bạn bắt đầu.</p><exercise name='Bài tập 3.04: Dự án v1.4.1'><p>Cải tiến quy trình triển khai để mỗi nhánh tạo một môi trường riêng. Nhánh main vẫn phải được triển khai ở namespace <em>default</em>.</p></exercise><exercise name='Bài tập 3.05: Dự án v1.4.2'><p>Cuối cùng, hãy tạo workflow mới để khi xóa một nhánh thì môi trường tương ứng cũng bị xóa.</p></exercise></div>","frontmatter":{"path":"/part-3/2-deployment-pipeline-vi","title":"Quy trình Triển khai (Deployment Pipeline)"},"fileAbsolutePath":"/home/runner/work/dwk2024/dwk2024/data/part-3/2-deployment-pipeline-vi.md"},"allPages":{"edges":[{"node":{"id":"7e706a38-3828-5118-bdec-3705a319a1b0","frontmatter":{"path":"/faq-vi","title":"Câu hỏi thường gặp"}}},{"node":{"id":"e1ed6713-5992-5f7f-95a1-17efd97f57d8","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"3102d88f-7297-56fb-af03-27d1079fffd1","frontmatter":{"path":"/","title":"Trang chủ"}}},{"node":{"id":"5225f2a2-20f9-50ce-93ac-7b38f3105103","frontmatter":{"path":"/faq","title":"FAQ"}}},{"node":{"id":"04c5ddbd-7839-580f-82da-bc9fdbb49f84","frontmatter":{"path":"/known-problems-solutions","title":"Các vấn đề bạn có thể gặp phải"}}},{"node":{"id":"c92ea568-3384-5ff8-8dfa-b9015597780d","frontmatter":{"path":"/known-problems-solutions","title":"Issues you may face"}}},{"node":{"id":"52d4cd1d-eb14-54f3-a18a-ef84b67c320d","frontmatter":{"path":"/index-en","title":"Homepage"}}},{"node":{"id":"5e6b6ee0-b381-53f0-b84c-af378792b131","frontmatter":{"path":"/registration-and-completion","title":"Registration and Completion"}}},{"node":{"id":"58688080-4aa8-54e6-8b8b-02de1c4f6410","frontmatter":{"path":"/unity-assignment","title":"Unity Assignment"}}},{"node":{"id":"d9c993b6-f6b4-59a1-b119-f3b7218eec6b","frontmatter":{"path":"/sanasto","title":"Sanasto"}}},{"node":{"id":"8a3ee5be-7557-5fcd-954b-2351e74cd585","frontmatter":{"path":"/part-0/1-intro-vi","title":"Giới thiệu khóa học"}}},{"node":{"id":"23082016-7bbd-5215-8485-4ffccbf3ea1a","frontmatter":{"path":"/part-0/1-intro","title":"Course Introduction"}}},{"node":{"id":"771eaa93-2ef2-5e0f-9e1e-55914c67c4ac","frontmatter":{"path":"/part-0","title":"Part 0"}}},{"node":{"id":"fe0342aa-a4c5-5b44-8591-71eb27f1a287","frontmatter":{"path":"/part-1/2-introduction-to-debugging-vi","title":"Giới thiệu về Debugging"}}},{"node":{"id":"1c236933-7ad5-5b61-8c07-07db3822d55a","frontmatter":{"path":"/part-1/2-introduction-to-debugging","title":"Introduction to Debugging"}}},{"node":{"id":"7fc5c062-6b94-53ec-9aaa-adca66ce672e","frontmatter":{"path":"/part-1/5-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"3c788edf-62db-5e86-9366-17b53eda9244","frontmatter":{"path":"/part-1/5-summary","title":"Summary"}}},{"node":{"id":"8ed3365b-b788-5806-8ec5-bec3cb0f94c8","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"fd467661-6b24-545f-904c-52f4a7ade6b7","frontmatter":{"path":"/part-2/1-networking-between-pods","title":"Networking between pods"}}},{"node":{"id":"46a4a0e4-d131-537d-aa72-5b6726163a7d","frontmatter":{"path":"/part-2/1-networking-between-pods-vi","title":"Kết nối mạng giữa các pod"}}},{"node":{"id":"8f3387b0-ec6e-5a86-982a-e52780d911f9","frontmatter":{"path":"/part-2/5-monitoring","title":"Monitoring"}}},{"node":{"id":"56110eda-875d-5bd9-a400-5bd5a009df7f","frontmatter":{"path":"/part-2/5-monitoring-vi","title":"Giám sát"}}},{"node":{"id":"79f1cddb-6995-51c2-bf98-2adc13de9b13","frontmatter":{"path":"/part-2/6-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"06173ac4-c2f8-57df-8dc8-450b5c2bb695","frontmatter":{"path":"/part-2/6-summary","title":"Summary"}}},{"node":{"id":"8c3d747d-4f87-5a46-99ac-dfd0af5a893b","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"8d9fd774-9dbe-5cca-8395-9226fcf82c4a","frontmatter":{"path":"/part-3/4-summary","title":"Tóm tắt"}}},{"node":{"id":"29bec4f5-8a0b-580d-ac84-9dbbd1d7152e","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"b98b2895-6c9d-5234-939d-2f547cbf8a06","frontmatter":{"path":"/part-3/4-summary","title":"Summary"}}},{"node":{"id":"4dd8302d-d170-5d38-8198-4d0947322bbc","frontmatter":{"path":"/part-4/4-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"0045695d-e541-5acc-b4b8-551023d01733","frontmatter":{"path":"/part-4/4-summary","title":"Summary"}}},{"node":{"id":"a917b24d-df2b-5199-ac98-cd0f7560c63f","frontmatter":{"path":"/part-4","title":"Part 4"}}},{"node":{"id":"2318c18f-86e6-5a4e-958a-d1c38f8615cd","frontmatter":{"path":"/part-5/4-beyond-kubernetes","title":"Beyond Kubernetes"}}},{"node":{"id":"eb339401-26c8-594c-98fd-2f30a95275cd","frontmatter":{"path":"/part-5/4-beyond-kubernetes-vi","title":"Vượt ra ngoài Kubernetes"}}},{"node":{"id":"781bd207-902e-59a2-a752-4958c2c93fb0","frontmatter":{"path":"/part-5/5-summary-vi","title":"Tóm tắt và kết thúc"}}},{"node":{"id":"1d8ff75c-065b-565d-9ceb-01b9a276ae7a","frontmatter":{"path":"/part-5/5-summary","title":"Summary and end"}}},{"node":{"id":"98132cca-4dc3-5942-a6f4-1da87bc81a23","frontmatter":{"path":"/part-0/2-kubernetes-in-three-diagrams","title":"Kubernetes in three diagrams"}}},{"node":{"id":"829fd216-f995-5a77-b201-bb971aec73b4","frontmatter":{"path":"/part-0/2-kubernetes-in-three-diagrams-vi","title":"Kubernetes qua ba sơ đồ"}}},{"node":{"id":"8931bcb7-c40e-5d57-aa80-c4333972fbb8","frontmatter":{"path":"/part-1/3-introduction-to-networking-vi","title":"Giới thiệu về Mạng"}}},{"node":{"id":"4fe00c0a-bb17-5d4c-8202-750493a755c9","frontmatter":{"path":"/part-1/4-introduction-to-storage-vi","title":"Giới thiệu về Lưu trữ"}}},{"node":{"id":"90b8e83a-9d55-550a-908a-316708ce7f8c","frontmatter":{"path":"/part-1/3-introduction-to-networking","title":"Introduction to Networking"}}},{"node":{"id":"6cc3be66-6091-58fc-bcbd-1f27f9473f85","frontmatter":{"path":"/part-1/4-introduction-to-storage","title":"Introduction to Storage"}}},{"node":{"id":"b53df746-c24f-57e3-a9f3-d6d621697689","frontmatter":{"path":"/part-2/2-organizing-a-cluster-vi","title":"Tổ chức một cụm"}}},{"node":{"id":"d5206d16-d2fe-51fd-8acd-d85ecf0be257","frontmatter":{"path":"/part-2/2-organizing-a-cluster","title":"Organizing a cluster"}}},{"node":{"id":"15be3d7c-b0b7-5bce-b3bf-8cec39d54630","frontmatter":{"path":"/part-2/3-configuring-applications-vi","title":"Cấu hình ứng dụng"}}},{"node":{"id":"e4534a9d-fb84-5d1f-83f0-35055feb0da7","frontmatter":{"path":"/part-2/3-configuring-applications","title":"Configuring applications"}}},{"node":{"id":"02389078-a12f-561a-8a54-fa99a6950b92","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs-vi","title":"StatefulSet và Job"}}},{"node":{"id":"466aa711-527b-55a0-871b-13468e65d344","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs","title":"StatefulSets and Jobs"}}},{"node":{"id":"84db9628-b3df-5ca1-9d3d-5924e02ae549","frontmatter":{"path":"/part-3/1-introduction-to-gke","title":"Introduction to Google Kubernetes Engine"}}},{"node":{"id":"0049e57f-0bc7-5689-9169-43848a972877","frontmatter":{"path":"/part-3/2-deployment-pipeline-vi","title":"Quy trình Triển khai (Deployment Pipeline)"}}},{"node":{"id":"61f18dc7-1abf-5c75-9b54-0cee11c76a40","frontmatter":{"path":"/part-3/2-deployment-pipeline","title":"Deployment Pipeline"}}},{"node":{"id":"7dfec8c7-8ccb-50da-949d-ebd1de395dc4","frontmatter":{"path":"/part-3/3-gke-features-vi","title":"Các tính năng của GKE"}}},{"node":{"id":"423cbc46-2dfa-57e6-9dc5-761a93729600","frontmatter":{"path":"/part-3/3-gke-features","title":"GKE features"}}},{"node":{"id":"bea18f34-dcdc-59b8-ba24-3011680a0c58","frontmatter":{"path":"/part-3/1-introduction-to-gke-vi","title":"Giới thiệu về Google Kubernetes Engine"}}},{"node":{"id":"6df9c7be-f930-5827-a39c-0c1698b23600","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"46f9ce68-5ccd-5787-bd59-03852ad6fdcb","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"0e981ec1-99e0-5005-ba9f-4f626a81b7ce","frontmatter":{"path":"/part-5/1-kubernetes-internals-vi","title":"Bên trong Kubernetes"}}},{"node":{"id":"31927db3-2182-55c7-b680-663754461d14","frontmatter":{"path":"/part-5/1-kubernetes-internals","title":"Kubernetes Internals"}}},{"node":{"id":"da1f8069-17bc-5c8e-9310-117bcedf5acf","frontmatter":{"path":"/part-5/2-custom-resource-definitions-vi","title":"Định nghĩa Tài nguyên Tùy chỉnh (Custom Resource Definitions)"}}},{"node":{"id":"68c64f9f-c9a5-544b-bafb-b061665cacd0","frontmatter":{"path":"/part-5/3-service-mesh-vi","title":"Service Mesh"}}},{"node":{"id":"ccefb04a-5790-57f6-869b-d255b2203667","frontmatter":{"path":"/part-5/2-custom-resource-definitions","title":"Custom Resource Definitions"}}},{"node":{"id":"20ceed4e-761d-54d4-9acf-2669eac533c6","frontmatter":{"path":"/part-5/3-service-mesh","title":"Service Mesh"}}},{"node":{"id":"306c87f3-9adb-5d8b-a3ce-072f8e6cfa43","frontmatter":{"path":"/part-5","title":"Part 5"}}},{"node":{"id":"97ead58a-8493-5fdd-808e-d4a56de573b0","frontmatter":{"path":"/part-1/1-first-deploy","title":"First Deploy"}}},{"node":{"id":"c179c521-bb62-52bd-808b-d4869df5302a","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Chiến lược cập nhật và Prometheus"}}},{"node":{"id":"898b0354-f1a2-5664-97de-d84b16018395","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"}}},{"node":{"id":"6981a9d7-619d-51a9-9490-74bc77c0f55b","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"}}},{"node":{"id":"6f4f18ce-5aa9-5bb5-9d74-0a631a78e6b3","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Hệ thống nhắn tin"}}},{"node":{"id":"a17c4c44-7396-543f-b6b4-7adf57808aa8","frontmatter":{"path":"/part-1/1-first-deploy-vi","title":"Triển khai đầu tiên"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}