{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-4/1-update-strategies-and-prometheus-vi","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Mục tiêu học tập"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Sau phần này, bạn có thể"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"So sánh các chiến lược cập nhật"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Triển khai phần mềm một cách "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"tự tin"}]},{"type":"text","value":" với canary releases"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Sử dụng Prometheus cho các truy vấn tùy chỉnh"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ở phần trước, chúng ta đã thực hiện cập nhật tự động với pipeline triển khai. Việc cập nhật "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"đơn giản là hoạt động"}]},{"type":"text","value":", nhưng chúng ta không biết quá trình cập nhật thực sự diễn ra như thế nào, ngoài việc một pod đã được thay đổi. Bây giờ hãy xem cách làm cho quá trình cập nhật an toàn hơn để giúp chúng ta đạt được mức "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/High_availability","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"sẵn sàng cao"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Có nhiều chiến lược cập nhật/triển khai/phát hành khác nhau. Chúng ta sẽ tập trung vào hai chiến lược:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Rolling update (Cập nhật cuốn chiếu)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Canary release (Phát hành canary)"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cả hai chiến lược này đều nhằm đảm bảo ứng dụng hoạt động trong và sau khi cập nhật. Thay vì cập nhật tất cả pod cùng lúc, ý tưởng là cập nhật từng pod một và xác nhận ứng dụng vẫn hoạt động."}]},{"type":"element","tagName":"h3","properties":{"id":"rolling-update","style":"position:relative;"},"children":[{"type":"text","value":"Rolling update"},{"type":"element","tagName":"a","properties":{"href":"#rolling-update","ariaLabel":"rolling update permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Mặc định, Kubernetes thực hiện "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/workloads/management/#updating-your-application-without-an-outage","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"rolling update"}]},{"type":"text","value":" khi chúng ta thay đổi image. Điều này có nghĩa là mỗi pod sẽ được cập nhật tuần tự. Rolling update là mặc định tuyệt vời vì nó giúp ứng dụng luôn sẵn sàng trong quá trình cập nhật. Nếu chúng ta đẩy một image bị lỗi, quá trình cập nhật sẽ tự động dừng lại."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tôi đã chuẩn bị một ứng dụng với 5 phiên bản. Tag v1 luôn hoạt động, v2 không bao giờ hoạt động, v3 hoạt động 90% thời gian, v4 sẽ chết sau 20 giây và v5 luôn hoạt động."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1"}]}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep created\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-7b5fd9ffc7-27cxt   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          87s\n  flaky-update-dep-7b5fd9ffc7-mp8vd   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          88s\n  flaky-update-dep-7b5fd9ffc7-m4smm   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          87s\n  flaky-update-dep-7b5fd9ffc7-nzl98   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          88s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bây giờ hãy đổi tag thành v2 và áp dụng lại."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n$ kubectl get po --watch\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":".."}]},{"type":"text","value":"."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bạn sẽ thấy rolling update được thực hiện nhưng tiếc là ứng dụng không còn hoạt động. Ứng dụng vẫn chạy, chỉ là có bug khiến nó không hoạt động đúng. Làm sao để thông báo lỗi này ra ngoài ứng dụng? Đây là lúc "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbes"}]}]},{"type":"text","value":" phát huy tác dụng."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Kubernetes Best Practices - Kubernetes Health Checks with Readiness and Liveness Probes"}]}]},{"type":"element","tagName":"iframe","properties":{"width":560,"height":315,"src":"https://www.youtube-nocookie.com/embed/mxEvAPQRwhw","frameBorder":"0","allow":"accelerometer; encrypted-media; gyroscope; picture-in-picture","allowFullScreen":true},"children":[]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Với "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbe"}]},{"type":"text","value":", Kubernetes có thể kiểm tra pod đã sẵn sàng xử lý request chưa. Ứng dụng có endpoint "},{"type":"element","tagName":"a","properties":{"href":"https://stackoverflow.com/questions/43380939/where-does-the-convention-of-using-healthz-for-application-health-checks-come-f","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"/healthz"}]},{"type":"text","value":" trên port 3541, chúng ta có thể dùng để kiểm tra sức khỏe. Nó sẽ trả về status code 500 nếu không hoạt động và 200 nếu hoạt động."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Hãy rollback về v1 để thử lại cập nhật lên v2."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"readinessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Đợi ban đầu trước khi kiểm tra readiness"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Tần suất kiểm tra"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ở đây "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"text","value":" và "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"text","value":" nghĩa là probe sẽ gửi sau 10 giây khi container khởi động và sau đó mỗi 5 giây. Nếu đổi tag thành v2 và áp dụng, kết quả sẽ như sau:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-f5c79dbc-8lnqm     "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          115s\n  flaky-update-dep-f5c79dbc-86fmd     "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          116s\n  flaky-update-dep-f5c79dbc-qzs9p     "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          98s\n  flaky-update-dep-54888b877b-dkctl   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          25s\n  flaky-update-dep-54888b877b-dbw29   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          24s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ba pod hoạt động bình thường, một pod v1 bị loại bỏ để nhường chỗ cho pod v2, nhưng vì pod v2 không hoạt động nên không bao giờ READY và quá trình cập nhật không thể tiếp tục."}]},{"type":"element","tagName":"h3","properties":{"id":"gke-ingress-va-pod-readiness","style":"position:relative;"},"children":[{"type":"text","value":"GKE ingress và pod readiness"},{"type":"element","tagName":"a","properties":{"href":"#gke-ingress-va-pod-readiness","ariaLabel":"gke ingress va pod readiness permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nếu bạn dùng Ingress trong ứng dụng, hãy lưu ý ReadinessProbe không hoạt động như mong đợi, request vẫn có thể được chuyển đến pod chưa "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ready"}]},{"type":"text","value":". Tài liệu "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#interpreted_hc","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"khuyến nghị"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Nếu các pod phục vụ cho Service của bạn có nhiều container, hoặc bạn dùng GKE Enterprise Ingress controller, hãy dùng BackendConfig CRD để định nghĩa tham số health check."}]},{"type":"text","value":" Nếu muốn dùng ingress mặc định của GKE, nên định nghĩa "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#direct_hc_instead","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"BackendConfig"}]},{"type":"text","value":". Thay vì dùng Ingress của nhà cung cấp, bạn nên dùng "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes/ingress-nginx/tree/main","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ingress-nginx"}]},{"type":"text","value":" để có hành vi nhất quán ở mọi nơi."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Cài đặt "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ingress-nginx"}]},{"type":"text","value":" rất dễ. Chạy các lệnh sau:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ helm repo "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"add"}]},{"type":"text","value":" ingress-nginx https://kubernetes.github.io/ingress-nginx\n$ helm repo update\n$ helm "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"install"}]},{"type":"text","value":" nginx-ingress ingress-nginx/ingress-nginx"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Trong "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/kubernetes-api/service-resources/ingress-v1/#IngressSpec","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ingress spec"}]},{"type":"text","value":", trường "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ingressClassName"}]},{"type":"text","value":" chỉ định controller sẽ dùng:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" networking.k8s.io/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Ingress\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ping"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"pong"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"ingress\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ingressClassName"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nginx "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# thêm dòng này"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"rules"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"http"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# rules ở đây"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Các ingress controller khả dụng (ngoài mặc định) có thể kiểm tra bằng "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"kubectl"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ kubectl get IngressClass\nNAME    CONTROLLER             PARAMETERS   AGE\nnginx   k8s.io/ingress-nginx   "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"none"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"       3h38m"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Có một bài học ở đây:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 31.304347826086953%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA20lEQVQY01VQWw6DIBDs/S/S9MekvY2JIhQEVHwCyofaDto07QYmsxtmd5bLI7nek5sQsiCk7/txHJdlCSHM87yu6+s/9n3/TS9KScZoVVVaa6WUEAJESlmWZdM0Xde1bftFdDeNqevaORfFuMMwpGmaZVlRFHmeM8ayIwghqDCKAnsewTk/kT+59z6KrbWYqSuNliAYi+FIwY0xYQlYBE/dEdZZbASCpT7i8ghMgDE/+3i+r62dpulE/MiJqG/bFsVI4BBeKKVATFbRgEI7cFRAojWtQdAdyvPn3lBCTKn6t4HHAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/5e58e3883a2af493d0d9ea7491b7c97e/a0b58/jami-ingress.webp 230w","/static/5e58e3883a2af493d0d9ea7491b7c97e/bc10c/jami-ingress.webp 460w","/static/5e58e3883a2af493d0d9ea7491b7c97e/966d8/jami-ingress.webp 920w","/static/5e58e3883a2af493d0d9ea7491b7c97e/445df/jami-ingress.webp 1380w","/static/5e58e3883a2af493d0d9ea7491b7c97e/31418/jami-ingress.webp 1740w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/5e58e3883a2af493d0d9ea7491b7c97e/81c8e/jami-ingress.png 230w","/static/5e58e3883a2af493d0d9ea7491b7c97e/08a84/jami-ingress.png 460w","/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png 920w","/static/5e58e3883a2af493d0d9ea7491b7c97e/b1001/jami-ingress.png 1380w","/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png 1740w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png","alt":"jami ingress","title":"jami ingress","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 4.01: Readiness Probe"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tạo ReadinessProbe cho ứng dụng Ping-pong. Nó chỉ sẵn sàng khi kết nối được với database."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Và một ReadinessProbe khác cho ứng dụng Log output. Nó chỉ sẵn sàng khi nhận được dữ liệu từ ứng dụng Ping-pong."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kiểm tra bằng cách áp dụng mọi thứ trừ statefulset của database. Kết quả "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl get po"}]},{"type":"text","value":" sẽ như sau trước khi database sẵn sàng:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"NAME                             READY   STATUS    RESTARTS   AGE\nlogoutput-dep-7f49547cf4-ttj4f   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/2     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          21s\npingpong-dep-9b698d6fb-jdgq9     "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          21s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Thêm database sẽ tự động chuyển trạng thái READY thành 2/2 và 1/1 cho Log output và Ping-pong."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Dù v2 không hoạt động, ít nhất ứng dụng vẫn chạy. Chúng ta chỉ cần đẩy bản cập nhật mới lên v2. Hãy thử v4, bản này sẽ hỏng sau một thời gian ngắn:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"ReadinessProbe có thể pass trong 20 giây đầu, nhưng sau đó mọi pod sẽ hỏng. Đáng tiếc "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbe"}]},{"type":"text","value":" không thể làm gì, deployment thành công nhưng ứng dụng bị lỗi."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl get po\n  NAME                               READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-dd78944f4-vv27w   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          111s\n  flaky-update-dep-dd78944f4-dnmcg   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          110s\n  flaky-update-dep-dd78944f4-zlh4v   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          92s\n  flaky-update-dep-dd78944f4-zczmw   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          90s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Hãy rollback về phiên bản trước. Điều này rất hữu ích nếu bạn cần rollback gấp:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl rollout undo deployment flaky-update-dep\n  deployment.apps/flaky-update-dep rolled back"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lệnh này sẽ rollback về phiên bản trước. Nếu đó là v2 (không hoạt động), cần dùng thêm flag:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl describe deployment flaky-update-dep "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"grep"}]},{"type":"text","value":" Image\n    Image:        jakousa/dwk-app8:v2\n\n$ kubectl rollout undo deployment flaky-update-dep --to-revision"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"\n  deployment.apps/flaky-update-dep rolled back\n\n$ kubectl describe deployment flaky-update-dep "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"grep"}]},{"type":"text","value":" Image\n    Image:        jakousa/dwk-app8:v1"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Đọc "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl rollout undo --help"}]},{"type":"text","value":" để biết thêm!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Có một probe khác có thể giúp trong tình huống như v4. "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"LivenessProbes"}]}]},{"type":"text","value":" cấu hình tương tự "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbes"}]},{"type":"text","value":", nhưng nếu check fail thì container sẽ được restart."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"readinessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Đợi ban đầu trước khi kiểm tra readiness"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Tần suất kiểm tra"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"livenessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"20"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Đợi ban đầu trước khi kiểm tra liveness"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Tần suất kiểm tra"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bây giờ hãy triển khai phiên bản tệ nhất, v3."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Sau một lúc, có thể sẽ như sau (nếu bạn may mắn):"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-fd65cd468-4vgwx   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3"}]},{"type":"text","value":"          2m30s\n  flaky-update-dep-fd65cd468-9h877   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"          2m49s\n  flaky-update-dep-fd65cd468-jpz2m   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3"}]},{"type":"text","value":"          2m13s\n  flaky-update-dep-fd65cd468-529nr   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"          2m50s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ít nhất vẫn còn pod hoạt động!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nếu ứng dụng của bạn khởi động chậm, có thể dùng "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-startup-probes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"StartupProbe"}]},{"type":"text","value":" để trì hoãn liveness probe, tránh bị restart sớm. Bạn có thể cần trong thực tế nhưng sẽ không bàn sâu ở khóa học này."}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 4.02: Dự án v1.7"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tạo các probe và endpoint cần thiết cho Dự án để đảm bảo ứng dụng hoạt động và kết nối được với database."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kiểm tra probe bằng cách dùng phiên bản không truy cập được database, ví dụ nhập sai URL hoặc thông tin đăng nhập."}]}]},{"type":"element","tagName":"h3","properties":{"id":"canary-release","style":"position:relative;"},"children":[{"type":"text","value":"Canary release"},{"type":"element","tagName":"a","properties":{"href":"#canary-release","ariaLabel":"canary release permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Với rolling update và các Probe, chúng ta có thể phát hành không downtime cho người dùng. Đôi khi như vậy là chưa đủ, bạn cần phát hành "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"một phần"}]},{"type":"text","value":" cho một số người dùng và thu thập dữ liệu trước khi phát hành rộng rãi. "},{"type":"element","tagName":"a","properties":{"href":"https://martinfowler.com/bliki/CanaryRelease.html","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Canary release"}]},{"type":"text","value":" là chiến lược phát hành cho một phần nhỏ người dùng dùng thử phiên bản mới. Khi tự tin hơn, tăng dần số người dùng cho đến khi không còn ai dùng phiên bản cũ."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Hiện tại, Canary không phải là chiến lược được Kubernetes hỗ trợ sẵn. Có thể do cách triển khai canary rất đa dạng. Chúng ta sẽ dùng "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Argo Rollouts"}]},{"type":"text","value":" để thử một kiểu canary release:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl create namespace argo-rollouts\n$ kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Bây giờ chúng ta có resource mới "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/migrating/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Rollout"}]},{"type":"text","value":". Rollout sẽ thay thế Deployment trước đó và cho phép dùng trường mới:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"rollout.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" argoproj.io/v1alpha1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Rollout\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"strategy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"canary"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"steps"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"setWeight"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"25"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"pause"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"duration"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 30s\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"setWeight"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"50"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"pause"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"duration"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 30s\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"readinessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Đợi ban đầu trước khi kiểm tra readiness"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Tần suất kiểm tra"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"livenessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"20"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Đợi ban đầu trước khi kiểm tra liveness"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Tần suất kiểm tra"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Chiến lược trên sẽ chuyển 25% ("},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/canary/#overview","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"setWeight"}]}]},{"type":"text","value":") pod sang phiên bản mới (ở đây là 1 pod), sau đó chờ 30 giây, chuyển 50% pod và lại chờ 30 giây cho đến khi tất cả pod được cập nhật. "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"kubectl plugin"}]},{"type":"text","value":" của Argo cũng cung cấp lệnh "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_promote/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"promote"}]},{"type":"text","value":" để tạm dừng rollout và chủ động chuyển tiếp."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Có các tùy chọn khác như "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/bluegreen/#maxunavailable","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"maxUnavailable"}]}]},{"type":"text","value":" nhưng mặc định là đủ. Tuy nhiên, chỉ rollout chậm lên production là chưa đủ cho canary. Cũng như rolling update, "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"chúng ta cần biết trạng thái ứng dụng"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Với resource AnalysisTemplate đã cài cùng Argo Rollouts, chúng ta có thể định nghĩa một bài test để ngăn phiên bản lỗi được phát hành."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Hãy mở rộng rollout với một analysis:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"strategy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"canary"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"steps"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"setWeight"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"50"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"analysis"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"templates"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"templateName"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" restart"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"rate\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"..."}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Analysis sẽ dùng template "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"restart-rate"}]},{"type":"text","value":". Tiếp theo, cần định nghĩa cách thực hiện analysis. Chúng ta sẽ cần Prometheus mà đã dùng ở "},{"type":"element","tagName":"a","properties":{"href":"/part-2/5-monitoring"},"children":[{"type":"text","value":"phần 2"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 4.03: Prometheus"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ở phần 2, chúng ta đã khởi động Prometheus nhưng mới chỉ làm quen. Hãy thực hiện một truy vấn thực tế để hiểu hơn."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Khởi động Prometheus bằng Helm và dùng port-forward để truy cập giao diện web. Port mặc định là 9090:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"$ kubectl -n prometheus get pods\n NAME                                                              READY   STATUS    RESTARTS   AGE\n  alertmanager-kube-prometheus-stack-1714-alertmanager-0            "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"2"}]},{"type":"text","value":"/2     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n  kube-prometheus-stack-1714-operator-94c596dbd-n5pcl               "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n  kube-prometheus-stack-1714644114-grafana-54cbbc4c46-m26f6         "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3"}]},{"type":"text","value":"/3     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n  kube-prometheus-stack-1714644114-kube-state-metrics-7cb796tpjbd   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-kdpln   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-sp9pg   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-vbbjk   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"/1     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n  prometheus-kube-prometheus-stack-1714-prometheus-0                "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"2"}]},{"type":"text","value":"/2     Running   "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"          3h19m\n\n$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1714-prometheus-0 "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"9090"}]},{"type":"text","value":":9090\n  Forwarding from "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"127.0"}]},{"type":"text","value":".0.1:9090 -"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"9090"}]},{"type":"text","value":"\n  Forwarding from "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":"::1"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":":9090 -"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"9090"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Truy cập "},{"type":"element","tagName":"a","properties":{"href":"http://localhost:9090","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://localhost:9090"}]},{"type":"text","value":" để viết truy vấn."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Viết truy vấn"}]},{"type":"text","value":" hiển thị số pod được tạo bởi StatefulSets trong namespace "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"prometheus"}]},{"type":"text","value":". Với setup trên, "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Value"}]},{"type":"text","value":" sẽ là 3 pod khác nhau:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 29.130434782608695%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA3UlEQVQY032NbUoEMQyGexnP5w08jb+8hogHUBDRH4vM7M7uNP1M25m2aezuIIqgDyEkD7y8QmutbBhMNT5aTBrXUReLsb/Kp9FU5SJYBLcOumBIpVJjdolSIQHWgjyBVFpKM01eqSAhGoPauNPsQXkJYZZOm0ztTcF4PNw/TVc3u+u7WSxrtrERUWvEzP1qVC+bqNY+m+nfsqxH55Q1w+xvH+HhHQUobUP2IZZSnl9e15z5D3qeW+P2bQQi9s6erLV+DPtcyrn/wtbdvjj7H9FuBP/LlvlFzDwjp8yfyXxZomT2YzcAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9295ed50207655f31d8c229e0e61375b/a0b58/prometheus-p4.webp 230w","/static/9295ed50207655f31d8c229e0e61375b/bc10c/prometheus-p4.webp 460w","/static/9295ed50207655f31d8c229e0e61375b/966d8/prometheus-p4.webp 920w","/static/9295ed50207655f31d8c229e0e61375b/445df/prometheus-p4.webp 1380w","/static/9295ed50207655f31d8c229e0e61375b/78de1/prometheus-p4.webp 1840w","/static/9295ed50207655f31d8c229e0e61375b/3c376/prometheus-p4.webp 1998w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9295ed50207655f31d8c229e0e61375b/81c8e/prometheus-p4.png 230w","/static/9295ed50207655f31d8c229e0e61375b/08a84/prometheus-p4.png 460w","/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png 920w","/static/9295ed50207655f31d8c229e0e61375b/b1001/prometheus-p4.png 1380w","/static/9295ed50207655f31d8c229e0e61375b/161ec/prometheus-p4.png 1840w","/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png 1998w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png","alt":"prometheus p4","title":"prometheus p4","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Truy vấn \"kube"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"pod"}]},{"type":"text","value":"info\" sẽ có đủ trường để lọc. Xem "},{"type":"element","tagName":"a","properties":{"href":"https://prometheus.io/docs/prometheus/latest/querying/basics/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"tài liệu"}]},{"type":"text","value":" để biết thêm về truy vấn."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"AnalysisTemplate sẽ dùng Prometheus để truy vấn trạng thái deployment. Kết quả truy vấn sẽ được so sánh với giá trị đặt trước. Trong ví dụ đơn giản này, nếu tổng số lần restart trong 2 phút qua lớn hơn 2, analysis sẽ fail. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"initialDelay"}]},{"type":"text","value":" đảm bảo test chỉ chạy khi đã có đủ dữ liệu. Template như sau:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"analysistemplate.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" argoproj.io/v1alpha1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" AnalysisTemplate\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" restart"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"rate\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metrics"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" restart"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"rate\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelay"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 2m\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"successCondition"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" result < 2\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"provider"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"prometheus"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"address"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" http"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//kube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"prometheus"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"stack"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"1602"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"prometheus.prometheus.svc.cluster.local"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"9090"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# DNS của Prometheus, tìm bằng kubectl describe svc ..."}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"query"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"element","tagName":"span","properties":{"className":["token","scalar","string"]},"children":[{"type":"text","value":"\n            scalar(\n              sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"}) -\n              sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"} offset 2m)\n            )"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Với Rollout và AnalysisTemplate mới, chúng ta có thể thử triển khai bất kỳ phiên bản nào một cách an toàn. Deploy v2 sẽ bị ngăn bởi các Probe đã thiết lập. Deploy v3 sẽ tự động rollback khi phát hiện crash ngẫu nhiên. v4 cũng sẽ fail, nhưng thời gian test ngắn có thể vẫn để lọt một phiên bản lỗi."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Plugin "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"kubectl của Argo Rollouts"}]},{"type":"text","value":" cho phép bạn xem trực quan Rollout và các resource liên quan. Để theo dõi Rollout khi deploy, chạy ở chế độ watch:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"kubectl argo rollouts get rollout flaky-update-dep --watch"}]}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 54.78260869565218%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAABDklEQVQoz41S25KDIAwF5CIKyqWAo6h1pvv/v7in25dudx/IIEMkycnJgWzbxjkXQtRac85SSkIIY4y02HVdfd8LIdd1nedZKQV3GIamZKDFGBGttYZLGSVApU25JITwylyWBYV88CZyIdvaLqVYayml4El/rMPXBvxs23vfdV3rkN7NOYeeOZfveJgZykECXGGH+1LhL+eYUpgnDWDOnwtmzIhBQMBpmnAAL87/o4I7zHuv5TzW6759Pa4YbzknM5re9HWv0M5aU7Kz9lnxF7vJWhfT6G5ynJR12gQ8GQQZY6A5lMcTQs9Mctaxz1EiwmeXz1TOvD2W9SyAhWz4r0a1HzsIH8eRatKD/uj6G1OTEKJqQgCjAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/05739caf16d8b8b3e0410e1ac9814510/a0b58/rollout.webp 230w","/static/05739caf16d8b8b3e0410e1ac9814510/bc10c/rollout.webp 460w","/static/05739caf16d8b8b3e0410e1ac9814510/966d8/rollout.webp 920w","/static/05739caf16d8b8b3e0410e1ac9814510/445df/rollout.webp 1380w","/static/05739caf16d8b8b3e0410e1ac9814510/331b9/rollout.webp 1748w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/05739caf16d8b8b3e0410e1ac9814510/81c8e/rollout.png 230w","/static/05739caf16d8b8b3e0410e1ac9814510/08a84/rollout.png 460w","/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png 920w","/static/05739caf16d8b8b3e0410e1ac9814510/b1001/rollout.png 1380w","/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png 1748w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png","alt":"rollout","title":"rollout","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ngoài pod, còn có "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/architecture/#analysistemplate-and-analysisrun","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"AnalysisRun"}]},{"type":"text","value":" là instance của bài test. Bạn cũng có thể thử "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/dashboard/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"dashboard của Argo Rollouts"}]},{"type":"text","value":" để xem trạng thái rollout trực quan hơn."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nói chung, "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"AnalysisTemplate"}]},{"type":"text","value":" không phụ thuộc vào Prometheus mà có thể dùng nguồn khác, ví dụ endpoint JSON."}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 4.04: Dự án v1.8"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Tạo AnalysisTemplate cho Dự án để theo dõi mức sử dụng CPU của tất cả container trong namespace."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nếu tổng "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"tốc độ"}]},{"type":"text","value":" sử dụng CPU của namespace vượt quá giá trị đặt trước (bạn tự chọn giá trị phù hợp cho dự án) trong vòng 10 phút, hãy revert cập nhật."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Đảm bảo ứng dụng không được cập nhật nếu giá trị đặt quá thấp."}]}]},{"type":"element","tagName":"h3","properties":{"id":"cac-chiến-lược-triển-khai-khac","style":"position:relative;"},"children":[{"type":"text","value":"Các chiến lược triển khai khác"},{"type":"element","tagName":"a","properties":{"href":"#cac-chi%E1%BA%BFn-l%C6%B0%E1%BB%A3c-tri%E1%BB%83n-khai-khac","ariaLabel":"cac chiến lược triển khai khac permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kubernetes hỗ trợ "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#recreate-deployment","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Recreate"}]},{"type":"text","value":", chiến lược này dừng toàn bộ pod cũ và thay thế bằng pod mới. Điều này tạo ra một khoảng downtime nhưng đảm bảo không có nhiều phiên bản chạy cùng lúc. Argo Rollouts hỗ trợ "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/bluegreen/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"BlueGreen"}]},{"type":"text","value":", trong đó phiên bản mới chạy song song với phiên bản cũ, nhưng traffic sẽ được chuyển sang phiên bản mới tại một thời điểm nhất định, ví dụ sau khi chạy script cập nhật hoặc QA đã duyệt phiên bản mới."}]},{"type":"element","tagName":"exercise","properties":{"name":"Bài tập 4.05: Dự án v1.9"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nói về cập nhật.\nỨng dụng todo của chúng ta nên có trường \"Done\" cho các todo đã hoàn thành.\nNó nên là một request PUT tới "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/todos/<id>"}]},{"type":"text","value":"."}]}]}]},"html":"<div><text-box variant='learningObjectives' name='Mục tiêu học tập'><p>Sau phần này, bạn có thể</p><ul>\n<li>So sánh các chiến lược cập nhật</li>\n<li>Triển khai phần mềm một cách <strong>tự tin</strong> với canary releases</li>\n<li>Sử dụng Prometheus cho các truy vấn tùy chỉnh</li>\n</ul></text-box><p>Ở phần trước, chúng ta đã thực hiện cập nhật tự động với pipeline triển khai. Việc cập nhật <em>đơn giản là hoạt động</em>, nhưng chúng ta không biết quá trình cập nhật thực sự diễn ra như thế nào, ngoài việc một pod đã được thay đổi. Bây giờ hãy xem cách làm cho quá trình cập nhật an toàn hơn để giúp chúng ta đạt được mức <a href=\"https://en.wikipedia.org/wiki/High_availability\" target=\"_blank\" rel=\"noopener noreferrer\">sẵn sàng cao</a>.</p><p>Có nhiều chiến lược cập nhật/triển khai/phát hành khác nhau. Chúng ta sẽ tập trung vào hai chiến lược:</p><ul>\n<li>Rolling update (Cập nhật cuốn chiếu)</li>\n<li>Canary release (Phát hành canary)</li>\n</ul><p>Cả hai chiến lược này đều nhằm đảm bảo ứng dụng hoạt động trong và sau khi cập nhật. Thay vì cập nhật tất cả pod cùng lúc, ý tưởng là cập nhật từng pod một và xác nhận ứng dụng vẫn hoạt động.</p><h3 id=\"rolling-update\" style=\"position:relative;\">Rolling update<a href=\"#rolling-update\" aria-label=\"rolling update permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Mặc định, Kubernetes thực hiện <a href=\"https://kubernetes.io/docs/concepts/workloads/management/#updating-your-application-without-an-outage\" target=\"_blank\" rel=\"noopener noreferrer\">rolling update</a> khi chúng ta thay đổi image. Điều này có nghĩa là mỗi pod sẽ được cập nhật tuần tự. Rolling update là mặc định tuyệt vời vì nó giúp ứng dụng luôn sẵn sàng trong quá trình cập nhật. Nếu chúng ta đẩy một image bị lỗi, quá trình cập nhật sẽ tự động dừng lại.</p><p>Tôi đã chuẩn bị một ứng dụng với 5 phiên bản. Tag v1 luôn hoạt động, v2 không bao giờ hoạt động, v3 hoạt động 90% thời gian, v4 sẽ chết sau 20 giây và v5 luôn hoạt động.</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1</code></pre></div><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep created\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-7b5fd9ffc7-27cxt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          87s\n  flaky-update-dep-7b5fd9ffc7-mp8vd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          88s\n  flaky-update-dep-7b5fd9ffc7-m4smm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          87s\n  flaky-update-dep-7b5fd9ffc7-nzl98   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          88s</code></pre></div><p>Bây giờ hãy đổi tag thành v2 và áp dụng lại.</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -f deployment.yaml\n$ kubectl get po --watch\n<span class=\"token punctuation\">..</span>.</code></pre></div><p>Bạn sẽ thấy rolling update được thực hiện nhưng tiếc là ứng dụng không còn hoạt động. Ứng dụng vẫn chạy, chỉ là có bug khiến nó không hoạt động đúng. Làm sao để thông báo lỗi này ra ngoài ứng dụng? Đây là lúc <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes\" target=\"_blank\" rel=\"noopener noreferrer\"><em>ReadinessProbes</em></a> phát huy tác dụng.</p><p><strong>Kubernetes Best Practices - Kubernetes Health Checks with Readiness and Liveness Probes</strong></p><iframe width=\"560\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/mxEvAPQRwhw\" frameborder=\"0\" allow=\"accelerometer; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe><p>Với <em>ReadinessProbe</em>, Kubernetes có thể kiểm tra pod đã sẵn sàng xử lý request chưa. Ứng dụng có endpoint <a href=\"https://stackoverflow.com/questions/43380939/where-does-the-convention-of-using-healthz-for-application-health-checks-come-f\" target=\"_blank\" rel=\"noopener noreferrer\">/healthz</a> trên port 3541, chúng ta có thể dùng để kiểm tra sức khỏe. Nó sẽ trả về status code 500 nếu không hoạt động và 200 nếu hoạt động.</p><p>Hãy rollback về v1 để thử lại cập nhật lên v2.</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\"># Đợi ban đầu trước khi kiểm tra readiness</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># Tần suất kiểm tra</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span></code></pre></div><p>Ở đây <em>initialDelaySeconds</em> và <em>periodSeconds</em> nghĩa là probe sẽ gửi sau 10 giây khi container khởi động và sau đó mỗi 5 giây. Nếu đổi tag thành v2 và áp dụng, kết quả sẽ như sau:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-f5c79dbc-8lnqm     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          115s\n  flaky-update-dep-f5c79dbc-86fmd     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          116s\n  flaky-update-dep-f5c79dbc-qzs9p     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          98s\n  flaky-update-dep-54888b877b-dkctl   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">0</span>          25s\n  flaky-update-dep-54888b877b-dbw29   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">0</span>          24s</code></pre></div><p>Ba pod hoạt động bình thường, một pod v1 bị loại bỏ để nhường chỗ cho pod v2, nhưng vì pod v2 không hoạt động nên không bao giờ READY và quá trình cập nhật không thể tiếp tục.</p><h3 id=\"gke-ingress-va-pod-readiness\" style=\"position:relative;\">GKE ingress và pod readiness<a href=\"#gke-ingress-va-pod-readiness\" aria-label=\"gke ingress va pod readiness permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Nếu bạn dùng Ingress trong ứng dụng, hãy lưu ý ReadinessProbe không hoạt động như mong đợi, request vẫn có thể được chuyển đến pod chưa <em>ready</em>. Tài liệu <a href=\"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#interpreted_hc\" target=\"_blank\" rel=\"noopener noreferrer\">khuyến nghị</a>:</p><p><em>Nếu các pod phục vụ cho Service của bạn có nhiều container, hoặc bạn dùng GKE Enterprise Ingress controller, hãy dùng BackendConfig CRD để định nghĩa tham số health check.</em> Nếu muốn dùng ingress mặc định của GKE, nên định nghĩa <a href=\"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#direct_hc_instead\" target=\"_blank\" rel=\"noopener noreferrer\">BackendConfig</a>. Thay vì dùng Ingress của nhà cung cấp, bạn nên dùng <a href=\"https://github.com/kubernetes/ingress-nginx/tree/main\" target=\"_blank\" rel=\"noopener noreferrer\">ingress-nginx</a> để có hành vi nhất quán ở mọi nơi.</p><p>Cài đặt <em>ingress-nginx</em> rất dễ. Chạy các lệnh sau:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ helm repo <span class=\"token function\">add</span> ingress-nginx https://kubernetes.github.io/ingress-nginx\n$ helm repo update\n$ helm <span class=\"token function\">install</span> nginx-ingress ingress-nginx/ingress-nginx</code></pre></div><p>Trong <a href=\"https://kubernetes.io/docs/reference/kubernetes-api/service-resources/ingress-v1/#IngressSpec\" target=\"_blank\" rel=\"noopener noreferrer\">ingress spec</a>, trường <em>ingressClassName</em> chỉ định controller sẽ dùng:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ping<span class=\"token punctuation\">-</span>pong<span class=\"token punctuation\">-</span>ingress\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> nginx <span class=\"token comment\"># thêm dòng này</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># rules ở đây</span></code></pre></div><p>Các ingress controller khả dụng (ngoài mặc định) có thể kiểm tra bằng <em>kubectl</em>:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl get IngressClass\nNAME    CONTROLLER             PARAMETERS   AGE\nnginx   k8s.io/ingress-nginx   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>       3h38m</code></pre></div><p>Có một bài học ở đây:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 31.304347826086953%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA20lEQVQY01VQWw6DIBDs/S/S9MekvY2JIhQEVHwCyofaDto07QYmsxtmd5bLI7nek5sQsiCk7/txHJdlCSHM87yu6+s/9n3/TS9KScZoVVVaa6WUEAJESlmWZdM0Xde1bftFdDeNqevaORfFuMMwpGmaZVlRFHmeM8ayIwghqDCKAnsewTk/kT+59z6KrbWYqSuNliAYi+FIwY0xYQlYBE/dEdZZbASCpT7i8ghMgDE/+3i+r62dpulE/MiJqG/bFsVI4BBeKKVATFbRgEI7cFRAojWtQdAdyvPn3lBCTKn6t4HHAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/a0b58/jami-ingress.webp 230w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/bc10c/jami-ingress.webp 460w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/966d8/jami-ingress.webp 920w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/445df/jami-ingress.webp 1380w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/31418/jami-ingress.webp 1740w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/81c8e/jami-ingress.png 230w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/08a84/jami-ingress.png 460w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png 920w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/b1001/jami-ingress.png 1380w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png 1740w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png\" alt=\"jami ingress\" title=\"jami ingress\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><exercise name='Bài tập 4.01: Readiness Probe'><p>Tạo ReadinessProbe cho ứng dụng Ping-pong. Nó chỉ sẵn sàng khi kết nối được với database.</p><p>Và một ReadinessProbe khác cho ứng dụng Log output. Nó chỉ sẵn sàng khi nhận được dữ liệu từ ứng dụng Ping-pong.</p><p>Kiểm tra bằng cách áp dụng mọi thứ trừ statefulset của database. Kết quả <code class=\"language-text\">kubectl get po</code> sẽ như sau trước khi database sẵn sàng:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">NAME                             READY   STATUS    RESTARTS   AGE\nlogoutput-dep-7f49547cf4-ttj4f   <span class=\"token number\">1</span>/2     Running   <span class=\"token number\">0</span>          21s\npingpong-dep-9b698d6fb-jdgq9     <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">0</span>          21s</code></pre></div><p>Thêm database sẽ tự động chuyển trạng thái READY thành 2/2 và 1/1 cho Log output và Ping-pong.</p></exercise><p>Dù v2 không hoạt động, ít nhất ứng dụng vẫn chạy. Chúng ta chỉ cần đẩy bản cập nhật mới lên v2. Hãy thử v4, bản này sẽ hỏng sau một thời gian ngắn:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured</code></pre></div><p>ReadinessProbe có thể pass trong 20 giây đầu, nhưng sau đó mọi pod sẽ hỏng. Đáng tiếc <em>ReadinessProbe</em> không thể làm gì, deployment thành công nhưng ứng dụng bị lỗi.</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get po\n  NAME                               READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-dd78944f4-vv27w   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">0</span>          111s\n  flaky-update-dep-dd78944f4-dnmcg   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">0</span>          110s\n  flaky-update-dep-dd78944f4-zlh4v   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">0</span>          92s\n  flaky-update-dep-dd78944f4-zczmw   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">0</span>          90s</code></pre></div><p>Hãy rollback về phiên bản trước. Điều này rất hữu ích nếu bạn cần rollback gấp:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl rollout undo deployment flaky-update-dep\n  deployment.apps/flaky-update-dep rolled back</code></pre></div><p>Lệnh này sẽ rollback về phiên bản trước. Nếu đó là v2 (không hoạt động), cần dùng thêm flag:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl describe deployment flaky-update-dep <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Image\n    Image:        jakousa/dwk-app8:v2\n\n$ kubectl rollout undo deployment flaky-update-dep --to-revision<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n  deployment.apps/flaky-update-dep rolled back\n\n$ kubectl describe deployment flaky-update-dep <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Image\n    Image:        jakousa/dwk-app8:v1</code></pre></div><p>Đọc <code class=\"language-text\">kubectl rollout undo --help</code> để biết thêm!</p><p>Có một probe khác có thể giúp trong tình huống như v4. <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes\" target=\"_blank\" rel=\"noopener noreferrer\"><em>LivenessProbes</em></a> cấu hình tương tự <em>ReadinessProbes</em>, nhưng nếu check fail thì container sẽ được restart.</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\"># Đợi ban đầu trước khi kiểm tra readiness</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># Tần suất kiểm tra</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span>\n          <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span> <span class=\"token comment\"># Đợi ban đầu trước khi kiểm tra liveness</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># Tần suất kiểm tra</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span></code></pre></div><p>Bây giờ hãy triển khai phiên bản tệ nhất, v3.</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured</code></pre></div><p>Sau một lúc, có thể sẽ như sau (nếu bạn may mắn):</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-fd65cd468-4vgwx   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">3</span>          2m30s\n  flaky-update-dep-fd65cd468-9h877   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">4</span>          2m49s\n  flaky-update-dep-fd65cd468-jpz2m   <span class=\"token number\">0</span>/1     Running   <span class=\"token number\">3</span>          2m13s\n  flaky-update-dep-fd65cd468-529nr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">4</span>          2m50s</code></pre></div><p>Ít nhất vẫn còn pod hoạt động!</p><p>Nếu ứng dụng của bạn khởi động chậm, có thể dùng <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-startup-probes\" target=\"_blank\" rel=\"noopener noreferrer\">StartupProbe</a> để trì hoãn liveness probe, tránh bị restart sớm. Bạn có thể cần trong thực tế nhưng sẽ không bàn sâu ở khóa học này.</p><exercise name='Bài tập 4.02: Dự án v1.7'><p>Tạo các probe và endpoint cần thiết cho Dự án để đảm bảo ứng dụng hoạt động và kết nối được với database.</p><p>Kiểm tra probe bằng cách dùng phiên bản không truy cập được database, ví dụ nhập sai URL hoặc thông tin đăng nhập.</p></exercise><h3 id=\"canary-release\" style=\"position:relative;\">Canary release<a href=\"#canary-release\" aria-label=\"canary release permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Với rolling update và các Probe, chúng ta có thể phát hành không downtime cho người dùng. Đôi khi như vậy là chưa đủ, bạn cần phát hành <em>một phần</em> cho một số người dùng và thu thập dữ liệu trước khi phát hành rộng rãi. <a href=\"https://martinfowler.com/bliki/CanaryRelease.html\" target=\"_blank\" rel=\"noopener noreferrer\">Canary release</a> là chiến lược phát hành cho một phần nhỏ người dùng dùng thử phiên bản mới. Khi tự tin hơn, tăng dần số người dùng cho đến khi không còn ai dùng phiên bản cũ.</p><p>Hiện tại, Canary không phải là chiến lược được Kubernetes hỗ trợ sẵn. Có thể do cách triển khai canary rất đa dạng. Chúng ta sẽ dùng <a href=\"https://argoproj.github.io/argo-rollouts/\" target=\"_blank\" rel=\"noopener noreferrer\">Argo Rollouts</a> để thử một kiểu canary release:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl create namespace argo-rollouts\n$ kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml</code></pre></div><p>Bây giờ chúng ta có resource mới <a href=\"https://argoproj.github.io/argo-rollouts/migrating/\" target=\"_blank\" rel=\"noopener noreferrer\">Rollout</a>. Rollout sẽ thay thế Deployment trước đó và cho phép dùng trường mới:</p><p><strong>rollout.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Rollout\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">canary</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">setWeight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">25</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pause</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">duration</span><span class=\"token punctuation\">:</span> 30s\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">setWeight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">50</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pause</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">duration</span><span class=\"token punctuation\">:</span> 30s\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\"># Đợi ban đầu trước khi kiểm tra readiness</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># Tần suất kiểm tra</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span>\n          <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span> <span class=\"token comment\"># Đợi ban đầu trước khi kiểm tra liveness</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># Tần suất kiểm tra</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span></code></pre></div><p>Chiến lược trên sẽ chuyển 25% (<a href=\"https://argoproj.github.io/argo-rollouts/features/canary/#overview\" target=\"_blank\" rel=\"noopener noreferrer\"><em>setWeight</em></a>) pod sang phiên bản mới (ở đây là 1 pod), sau đó chờ 30 giây, chuyển 50% pod và lại chờ 30 giây cho đến khi tất cả pod được cập nhật. <a href=\"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl plugin</a> của Argo cũng cung cấp lệnh <a href=\"https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_promote/\" target=\"_blank\" rel=\"noopener noreferrer\">promote</a> để tạm dừng rollout và chủ động chuyển tiếp.</p><p>Có các tùy chọn khác như <a href=\"https://argoproj.github.io/argo-rollouts/features/bluegreen/#maxunavailable\" target=\"_blank\" rel=\"noopener noreferrer\"><em>maxUnavailable</em></a> nhưng mặc định là đủ. Tuy nhiên, chỉ rollout chậm lên production là chưa đủ cho canary. Cũng như rolling update, <em>chúng ta cần biết trạng thái ứng dụng</em>.</p><p>Với resource AnalysisTemplate đã cài cùng Argo Rollouts, chúng ta có thể định nghĩa một bài test để ngăn phiên bản lỗi được phát hành.</p><p>Hãy mở rộng rollout với một analysis:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token punctuation\">...</span>\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">canary</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">setWeight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">50</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">analysis</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">templates</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">templateName</span><span class=\"token punctuation\">:</span> restart<span class=\"token punctuation\">-</span>rate\n    <span class=\"token comment\"># ...</span>\n  <span class=\"token punctuation\">...</span></code></pre></div><p>Analysis sẽ dùng template <em>restart-rate</em>. Tiếp theo, cần định nghĩa cách thực hiện analysis. Chúng ta sẽ cần Prometheus mà đã dùng ở <a href=\"/part-2/5-monitoring\">phần 2</a>.</p><exercise name='Bài tập 4.03: Prometheus'><p>Ở phần 2, chúng ta đã khởi động Prometheus nhưng mới chỉ làm quen. Hãy thực hiện một truy vấn thực tế để hiểu hơn.</p><p>Khởi động Prometheus bằng Helm và dùng port-forward để truy cập giao diện web. Port mặc định là 9090:</p><div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ kubectl -n prometheus get pods\n NAME                                                              READY   STATUS    RESTARTS   AGE\n  alertmanager-kube-prometheus-stack-1714-alertmanager-0            <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          3h19m\n  kube-prometheus-stack-1714-operator-94c596dbd-n5pcl               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3h19m\n  kube-prometheus-stack-1714644114-grafana-54cbbc4c46-m26f6         <span class=\"token number\">3</span>/3     Running   <span class=\"token number\">0</span>          3h19m\n  kube-prometheus-stack-1714644114-kube-state-metrics-7cb796tpjbd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-kdpln   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-sp9pg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-vbbjk   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3h19m\n  prometheus-kube-prometheus-stack-1714-prometheus-0                <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          3h19m\n\n$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1714-prometheus-0 <span class=\"token number\">9090</span>:9090\n  Forwarding from <span class=\"token number\">127.0</span>.0.1:9090 -<span class=\"token operator\">></span> <span class=\"token number\">9090</span>\n  Forwarding from <span class=\"token punctuation\">[</span>::1<span class=\"token punctuation\">]</span>:9090 -<span class=\"token operator\">></span> <span class=\"token number\">9090</span></code></pre></div><p>Truy cập <a href=\"http://localhost:9090\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:9090</a> để viết truy vấn.</p><p><strong>Viết truy vấn</strong> hiển thị số pod được tạo bởi StatefulSets trong namespace <em>prometheus</em>. Với setup trên, <em>Value</em> sẽ là 3 pod khác nhau:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 29.130434782608695%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA3UlEQVQY032NbUoEMQyGexnP5w08jb+8hogHUBDRH4vM7M7uNP1M25m2aezuIIqgDyEkD7y8QmutbBhMNT5aTBrXUReLsb/Kp9FU5SJYBLcOumBIpVJjdolSIQHWgjyBVFpKM01eqSAhGoPauNPsQXkJYZZOm0ztTcF4PNw/TVc3u+u7WSxrtrERUWvEzP1qVC+bqNY+m+nfsqxH55Q1w+xvH+HhHQUobUP2IZZSnl9e15z5D3qeW+P2bQQi9s6erLV+DPtcyrn/wtbdvjj7H9FuBP/LlvlFzDwjp8yfyXxZomT2YzcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/9295ed50207655f31d8c229e0e61375b/a0b58/prometheus-p4.webp 230w,\n/static/9295ed50207655f31d8c229e0e61375b/bc10c/prometheus-p4.webp 460w,\n/static/9295ed50207655f31d8c229e0e61375b/966d8/prometheus-p4.webp 920w,\n/static/9295ed50207655f31d8c229e0e61375b/445df/prometheus-p4.webp 1380w,\n/static/9295ed50207655f31d8c229e0e61375b/78de1/prometheus-p4.webp 1840w,\n/static/9295ed50207655f31d8c229e0e61375b/3c376/prometheus-p4.webp 1998w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/9295ed50207655f31d8c229e0e61375b/81c8e/prometheus-p4.png 230w,\n/static/9295ed50207655f31d8c229e0e61375b/08a84/prometheus-p4.png 460w,\n/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png 920w,\n/static/9295ed50207655f31d8c229e0e61375b/b1001/prometheus-p4.png 1380w,\n/static/9295ed50207655f31d8c229e0e61375b/161ec/prometheus-p4.png 1840w,\n/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png 1998w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png\" alt=\"prometheus p4\" title=\"prometheus p4\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Truy vấn \"kube<em>pod</em>info\" sẽ có đủ trường để lọc. Xem <a href=\"https://prometheus.io/docs/prometheus/latest/querying/basics/\" target=\"_blank\" rel=\"noopener noreferrer\">tài liệu</a> để biết thêm về truy vấn.</p></exercise><p>AnalysisTemplate sẽ dùng Prometheus để truy vấn trạng thái deployment. Kết quả truy vấn sẽ được so sánh với giá trị đặt trước. Trong ví dụ đơn giản này, nếu tổng số lần restart trong 2 phút qua lớn hơn 2, analysis sẽ fail. <em>initialDelay</em> đảm bảo test chỉ chạy khi đã có đủ dữ liệu. Template như sau:</p><p><strong>analysistemplate.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AnalysisTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> restart<span class=\"token punctuation\">-</span>rate\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">metrics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> restart<span class=\"token punctuation\">-</span>rate\n      <span class=\"token key atrule\">initialDelay</span><span class=\"token punctuation\">:</span> 2m\n      <span class=\"token key atrule\">successCondition</span><span class=\"token punctuation\">:</span> result &lt; 2\n      <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">prometheus</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//kube<span class=\"token punctuation\">-</span>prometheus<span class=\"token punctuation\">-</span>stack<span class=\"token punctuation\">-</span>1602<span class=\"token punctuation\">-</span>prometheus.prometheus.svc.cluster.local<span class=\"token punctuation\">:</span><span class=\"token number\">9090</span> <span class=\"token comment\"># DNS của Prometheus, tìm bằng kubectl describe svc ...</span>\n          <span class=\"token key atrule\">query</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            scalar(\n              sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"}) -\n              sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"} offset 2m)\n            )</span></code></pre></div><p>Với Rollout và AnalysisTemplate mới, chúng ta có thể thử triển khai bất kỳ phiên bản nào một cách an toàn. Deploy v2 sẽ bị ngăn bởi các Probe đã thiết lập. Deploy v3 sẽ tự động rollback khi phát hiện crash ngẫu nhiên. v4 cũng sẽ fail, nhưng thời gian test ngắn có thể vẫn để lọt một phiên bản lỗi.</p><p>Plugin <a href=\"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl của Argo Rollouts</a> cho phép bạn xem trực quan Rollout và các resource liên quan. Để theo dõi Rollout khi deploy, chạy ở chế độ watch:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl argo rollouts get rollout flaky-update-dep --watch</code></pre></div><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 54.78260869565218%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAABDklEQVQoz41S25KDIAwF5CIKyqWAo6h1pvv/v7in25dudx/IIEMkycnJgWzbxjkXQtRac85SSkIIY4y02HVdfd8LIdd1nedZKQV3GIamZKDFGBGttYZLGSVApU25JITwylyWBYV88CZyIdvaLqVYayml4El/rMPXBvxs23vfdV3rkN7NOYeeOZfveJgZykECXGGH+1LhL+eYUpgnDWDOnwtmzIhBQMBpmnAAL87/o4I7zHuv5TzW6759Pa4YbzknM5re9HWv0M5aU7Kz9lnxF7vJWhfT6G5ynJR12gQ8GQQZY6A5lMcTQs9Mctaxz1EiwmeXz1TOvD2W9SyAhWz4r0a1HzsIH8eRatKD/uj6G1OTEKJqQgCjAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/05739caf16d8b8b3e0410e1ac9814510/a0b58/rollout.webp 230w,\n/static/05739caf16d8b8b3e0410e1ac9814510/bc10c/rollout.webp 460w,\n/static/05739caf16d8b8b3e0410e1ac9814510/966d8/rollout.webp 920w,\n/static/05739caf16d8b8b3e0410e1ac9814510/445df/rollout.webp 1380w,\n/static/05739caf16d8b8b3e0410e1ac9814510/331b9/rollout.webp 1748w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/05739caf16d8b8b3e0410e1ac9814510/81c8e/rollout.png 230w,\n/static/05739caf16d8b8b3e0410e1ac9814510/08a84/rollout.png 460w,\n/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png 920w,\n/static/05739caf16d8b8b3e0410e1ac9814510/b1001/rollout.png 1380w,\n/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png 1748w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png\" alt=\"rollout\" title=\"rollout\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Ngoài pod, còn có <a href=\"https://argoproj.github.io/argo-rollouts/architecture/#analysistemplate-and-analysisrun\" target=\"_blank\" rel=\"noopener noreferrer\">AnalysisRun</a> là instance của bài test. Bạn cũng có thể thử <a href=\"https://argoproj.github.io/argo-rollouts/dashboard/\" target=\"_blank\" rel=\"noopener noreferrer\">dashboard của Argo Rollouts</a> để xem trạng thái rollout trực quan hơn.</p><p>Nói chung, <em>AnalysisTemplate</em> không phụ thuộc vào Prometheus mà có thể dùng nguồn khác, ví dụ endpoint JSON.</p><exercise name='Bài tập 4.04: Dự án v1.8'><p>Tạo AnalysisTemplate cho Dự án để theo dõi mức sử dụng CPU của tất cả container trong namespace.</p><p>Nếu tổng <strong>tốc độ</strong> sử dụng CPU của namespace vượt quá giá trị đặt trước (bạn tự chọn giá trị phù hợp cho dự án) trong vòng 10 phút, hãy revert cập nhật.</p><p>Đảm bảo ứng dụng không được cập nhật nếu giá trị đặt quá thấp.</p></exercise><h3 id=\"cac-chiến-lược-triển-khai-khac\" style=\"position:relative;\">Các chiến lược triển khai khác<a href=\"#cac-chi%E1%BA%BFn-l%C6%B0%E1%BB%A3c-tri%E1%BB%83n-khai-khac\" aria-label=\"cac chiến lược triển khai khac permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Kubernetes hỗ trợ <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#recreate-deployment\" target=\"_blank\" rel=\"noopener noreferrer\">Recreate</a>, chiến lược này dừng toàn bộ pod cũ và thay thế bằng pod mới. Điều này tạo ra một khoảng downtime nhưng đảm bảo không có nhiều phiên bản chạy cùng lúc. Argo Rollouts hỗ trợ <a href=\"https://argoproj.github.io/argo-rollouts/features/bluegreen/\" target=\"_blank\" rel=\"noopener noreferrer\">BlueGreen</a>, trong đó phiên bản mới chạy song song với phiên bản cũ, nhưng traffic sẽ được chuyển sang phiên bản mới tại một thời điểm nhất định, ví dụ sau khi chạy script cập nhật hoặc QA đã duyệt phiên bản mới.</p><exercise name='Bài tập 4.05: Dự án v1.9'><p>Nói về cập nhật.\nỨng dụng todo của chúng ta nên có trường \"Done\" cho các todo đã hoàn thành.\nNó nên là một request PUT tới <code class=\"language-text\">/todos/&lt;id&gt;</code>.</p></exercise></div>","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus-vi","title":"Chiến lược cập nhật và Prometheus"},"fileAbsolutePath":"/home/runner/work/dwk2024/dwk2024/data/part-4/1-update-strategies-and-prometheus-vi.md"},"allPages":{"edges":[{"node":{"id":"5225f2a2-20f9-50ce-93ac-7b38f3105103","frontmatter":{"path":"/faq","title":"FAQ"}}},{"node":{"id":"e1ed6713-5992-5f7f-95a1-17efd97f57d8","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"7e706a38-3828-5118-bdec-3705a319a1b0","frontmatter":{"path":"/faq-vi","title":"Câu hỏi thường gặp"}}},{"node":{"id":"52d4cd1d-eb14-54f3-a18a-ef84b67c320d","frontmatter":{"path":"/index-en","title":"Homepage"}}},{"node":{"id":"04c5ddbd-7839-580f-82da-bc9fdbb49f84","frontmatter":{"path":"/known-problems-solutions-vi","title":"Các vấn đề bạn có thể gặp phải"}}},{"node":{"id":"3102d88f-7297-56fb-af03-27d1079fffd1","frontmatter":{"path":"/","title":"Trang chủ"}}},{"node":{"id":"c92ea568-3384-5ff8-8dfa-b9015597780d","frontmatter":{"path":"/known-problems-solutions","title":"Issues you may face"}}},{"node":{"id":"5e6b6ee0-b381-53f0-b84c-af378792b131","frontmatter":{"path":"/registration-and-completion","title":"Registration and Completion"}}},{"node":{"id":"58688080-4aa8-54e6-8b8b-02de1c4f6410","frontmatter":{"path":"/unity-assignment","title":"Unity Assignment"}}},{"node":{"id":"d9c993b6-f6b4-59a1-b119-f3b7218eec6b","frontmatter":{"path":"/sanasto","title":"Sanasto"}}},{"node":{"id":"8a3ee5be-7557-5fcd-954b-2351e74cd585","frontmatter":{"path":"/part-0/1-intro-vi","title":"Giới thiệu khóa học"}}},{"node":{"id":"23082016-7bbd-5215-8485-4ffccbf3ea1a","frontmatter":{"path":"/part-0/1-intro","title":"Course Introduction"}}},{"node":{"id":"771eaa93-2ef2-5e0f-9e1e-55914c67c4ac","frontmatter":{"path":"/part-0","title":"Part 0"}}},{"node":{"id":"1c236933-7ad5-5b61-8c07-07db3822d55a","frontmatter":{"path":"/part-1/2-introduction-to-debugging","title":"Introduction to Debugging"}}},{"node":{"id":"fe0342aa-a4c5-5b44-8591-71eb27f1a287","frontmatter":{"path":"/part-1/2-introduction-to-debugging-vi","title":"Giới thiệu về Debugging"}}},{"node":{"id":"7fc5c062-6b94-53ec-9aaa-adca66ce672e","frontmatter":{"path":"/part-1/5-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"3c788edf-62db-5e86-9366-17b53eda9244","frontmatter":{"path":"/part-1/5-summary","title":"Summary"}}},{"node":{"id":"8ed3365b-b788-5806-8ec5-bec3cb0f94c8","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"46a4a0e4-d131-537d-aa72-5b6726163a7d","frontmatter":{"path":"/part-2/1-networking-between-pods-vi","title":"Kết nối mạng giữa các pod"}}},{"node":{"id":"fd467661-6b24-545f-904c-52f4a7ade6b7","frontmatter":{"path":"/part-2/1-networking-between-pods","title":"Networking between pods"}}},{"node":{"id":"56110eda-875d-5bd9-a400-5bd5a009df7f","frontmatter":{"path":"/part-2/5-monitoring-vi","title":"Giám sát"}}},{"node":{"id":"8f3387b0-ec6e-5a86-982a-e52780d911f9","frontmatter":{"path":"/part-2/5-monitoring","title":"Monitoring"}}},{"node":{"id":"06173ac4-c2f8-57df-8dc8-450b5c2bb695","frontmatter":{"path":"/part-2/6-summary","title":"Summary"}}},{"node":{"id":"79f1cddb-6995-51c2-bf98-2adc13de9b13","frontmatter":{"path":"/part-2/6-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"8c3d747d-4f87-5a46-99ac-dfd0af5a893b","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"8d9fd774-9dbe-5cca-8395-9226fcf82c4a","frontmatter":{"path":"/part-3/4-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"b98b2895-6c9d-5234-939d-2f547cbf8a06","frontmatter":{"path":"/part-3/4-summary","title":"Summary"}}},{"node":{"id":"29bec4f5-8a0b-580d-ac84-9dbbd1d7152e","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"0045695d-e541-5acc-b4b8-551023d01733","frontmatter":{"path":"/part-4/4-summary","title":"Summary"}}},{"node":{"id":"a917b24d-df2b-5199-ac98-cd0f7560c63f","frontmatter":{"path":"/part-4","title":"Part 4"}}},{"node":{"id":"4dd8302d-d170-5d38-8198-4d0947322bbc","frontmatter":{"path":"/part-4/4-summary-vi","title":"Tóm tắt"}}},{"node":{"id":"eb339401-26c8-594c-98fd-2f30a95275cd","frontmatter":{"path":"/part-5/4-beyond-kubernetes-vi","title":"Vượt ra ngoài Kubernetes"}}},{"node":{"id":"2318c18f-86e6-5a4e-958a-d1c38f8615cd","frontmatter":{"path":"/part-5/4-beyond-kubernetes","title":"Beyond Kubernetes"}}},{"node":{"id":"1d8ff75c-065b-565d-9ceb-01b9a276ae7a","frontmatter":{"path":"/part-5/5-summary","title":"Summary and end"}}},{"node":{"id":"781bd207-902e-59a2-a752-4958c2c93fb0","frontmatter":{"path":"/part-5/5-summary-vi","title":"Tóm tắt và kết thúc"}}},{"node":{"id":"829fd216-f995-5a77-b201-bb971aec73b4","frontmatter":{"path":"/part-0/2-kubernetes-in-three-diagrams-vi","title":"Kubernetes qua ba sơ đồ"}}},{"node":{"id":"98132cca-4dc3-5942-a6f4-1da87bc81a23","frontmatter":{"path":"/part-0/2-kubernetes-in-three-diagrams","title":"Kubernetes in three diagrams"}}},{"node":{"id":"8931bcb7-c40e-5d57-aa80-c4333972fbb8","frontmatter":{"path":"/part-1/3-introduction-to-networking-vi","title":"Giới thiệu về Mạng"}}},{"node":{"id":"90b8e83a-9d55-550a-908a-316708ce7f8c","frontmatter":{"path":"/part-1/3-introduction-to-networking","title":"Introduction to Networking"}}},{"node":{"id":"4fe00c0a-bb17-5d4c-8202-750493a755c9","frontmatter":{"path":"/part-1/4-introduction-to-storage-vi","title":"Giới thiệu về Lưu trữ"}}},{"node":{"id":"6cc3be66-6091-58fc-bcbd-1f27f9473f85","frontmatter":{"path":"/part-1/4-introduction-to-storage","title":"Introduction to Storage"}}},{"node":{"id":"d5206d16-d2fe-51fd-8acd-d85ecf0be257","frontmatter":{"path":"/part-2/2-organizing-a-cluster","title":"Organizing a cluster"}}},{"node":{"id":"b53df746-c24f-57e3-a9f3-d6d621697689","frontmatter":{"path":"/part-2/2-organizing-a-cluster-vi","title":"Tổ chức một cụm"}}},{"node":{"id":"e4534a9d-fb84-5d1f-83f0-35055feb0da7","frontmatter":{"path":"/part-2/3-configuring-applications","title":"Configuring applications"}}},{"node":{"id":"15be3d7c-b0b7-5bce-b3bf-8cec39d54630","frontmatter":{"path":"/part-2/3-configuring-applications-vi","title":"Cấu hình ứng dụng"}}},{"node":{"id":"02389078-a12f-561a-8a54-fa99a6950b92","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs-vi","title":"StatefulSet và Job"}}},{"node":{"id":"466aa711-527b-55a0-871b-13468e65d344","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs","title":"StatefulSets and Jobs"}}},{"node":{"id":"bea18f34-dcdc-59b8-ba24-3011680a0c58","frontmatter":{"path":"/part-3/1-introduction-to-gke-vi","title":"Giới thiệu về Google Kubernetes Engine"}}},{"node":{"id":"0049e57f-0bc7-5689-9169-43848a972877","frontmatter":{"path":"/part-3/2-deployment-pipeline-vi","title":"Quy trình Triển khai (Deployment Pipeline)"}}},{"node":{"id":"61f18dc7-1abf-5c75-9b54-0cee11c76a40","frontmatter":{"path":"/part-3/2-deployment-pipeline","title":"Deployment Pipeline"}}},{"node":{"id":"84db9628-b3df-5ca1-9d3d-5924e02ae549","frontmatter":{"path":"/part-3/1-introduction-to-gke","title":"Introduction to Google Kubernetes Engine"}}},{"node":{"id":"7dfec8c7-8ccb-50da-949d-ebd1de395dc4","frontmatter":{"path":"/part-3/3-gke-features-vi","title":"Các tính năng của GKE"}}},{"node":{"id":"423cbc46-2dfa-57e6-9dc5-761a93729600","frontmatter":{"path":"/part-3/3-gke-features","title":"GKE features"}}},{"node":{"id":"6df9c7be-f930-5827-a39c-0c1698b23600","frontmatter":{"path":"/part-4/3-gitops-vi","title":"Triển khai GitOps"}}},{"node":{"id":"46f9ce68-5ccd-5787-bd59-03852ad6fdcb","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"da1f8069-17bc-5c8e-9310-117bcedf5acf","frontmatter":{"path":"/part-5/2-custom-resource-definitions-vi","title":"Định nghĩa Tài nguyên Tùy chỉnh (Custom Resource Definitions)"}}},{"node":{"id":"31927db3-2182-55c7-b680-663754461d14","frontmatter":{"path":"/part-5/1-kubernetes-internals","title":"Kubernetes Internals"}}},{"node":{"id":"68c64f9f-c9a5-544b-bafb-b061665cacd0","frontmatter":{"path":"/part-5/3-service-mesh-vi","title":"Service Mesh"}}},{"node":{"id":"0e981ec1-99e0-5005-ba9f-4f626a81b7ce","frontmatter":{"path":"/part-5/1-kubernetes-internals-vi","title":"Bên trong Kubernetes"}}},{"node":{"id":"20ceed4e-761d-54d4-9acf-2669eac533c6","frontmatter":{"path":"/part-5/3-service-mesh","title":"Service Mesh"}}},{"node":{"id":"ccefb04a-5790-57f6-869b-d255b2203667","frontmatter":{"path":"/part-5/2-custom-resource-definitions","title":"Custom Resource Definitions"}}},{"node":{"id":"306c87f3-9adb-5d8b-a3ce-072f8e6cfa43","frontmatter":{"path":"/part-5","title":"Part 5"}}},{"node":{"id":"97ead58a-8493-5fdd-808e-d4a56de573b0","frontmatter":{"path":"/part-1/1-first-deploy","title":"First Deploy"}}},{"node":{"id":"c179c521-bb62-52bd-808b-d4869df5302a","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus-vi","title":"Chiến lược cập nhật và Prometheus"}}},{"node":{"id":"6f4f18ce-5aa9-5bb5-9d74-0a631a78e6b3","frontmatter":{"path":"/part-4/2-messaging-systems-vi","title":"Hệ thống nhắn tin"}}},{"node":{"id":"898b0354-f1a2-5664-97de-d84b16018395","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"}}},{"node":{"id":"6981a9d7-619d-51a9-9490-74bc77c0f55b","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"}}},{"node":{"id":"a17c4c44-7396-543f-b6b4-7adf57808aa8","frontmatter":{"path":"/part-1/1-first-deploy-vi","title":"Triển khai đầu tiên"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}